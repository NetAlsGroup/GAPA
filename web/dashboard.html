<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GAPA Console · 资源监控与算法控制台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --panel-border: #e2e8f0;
      --text: #0f172a;
      --muted: #6b7280;
      --blue-600: #2563eb;
      --blue-700: #1d4ed8;
      --blue-50: #eff6ff;
      --rose: #e11d48;
      --card-border: #e5e7eb;
      --soft-bg: #f8fafc;
      --accent-weak: rgba(37, 99, 235, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "IBM Plex Sans", "Source Sans 3", "Noto Sans SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(1200px 400px at 20% -20%, #e9f0ff 0%, rgba(233,240,255,0) 60%),
        linear-gradient(180deg, #f8fafc 0%, #f3f6fb 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .hidden { display: none !important; }
    .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

    .header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--panel-border);
    }
    .header-inner { display: flex; align-items: center; justify-content: space-between; padding: 14px 0; gap: 16px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand img { height: 36px; width: auto; }
    .title { font-size: 20px; font-weight: 800; letter-spacing: .2px; }
    .subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      background: var(--blue-50);
      color: var(--blue-700);
      border: 1px solid var(--panel-border);
      white-space: nowrap;
    }

    .layout { display: flex; gap: 18px; padding: 16px 0 24px; }
    .sidebar {
      width: 240px;
      flex: 0 0 240px;
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.04);
      padding: 10px;
      position: sticky;
      top: 72px;
      height: calc(100vh - 92px);
      overflow: auto;
    }
    .nav-title { font-size: 12px; color: var(--muted); font-weight: 800; padding: 8px 10px; }
    .nav-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      font-size: 13px;
      font-weight: 800;
      cursor: pointer;
      text-align: left;
    }
    .nav-item:hover { background: #f1f5f9; border-color: var(--panel-border); }
    .nav-item--active { background: #eef2ff; border-color: #c7d2fe; color: var(--blue-700); }
    .nav-badge {
      font-size: 11px;
      font-weight: 900;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e5edff;
      color: #1e3a8a;
      border: 1px solid #dbeafe;
    }
    .content { flex: 1; min-width: 0; }

    .section {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(15, 23, 42, 0.04);
      padding: 18px;
    }
    .section-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .section-title { font-size: 16px; font-weight: 800; }

    .btn {
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .btn-primary { background: var(--blue-600); color: #fff; box-shadow: 0 1px 2px rgba(37,99,235,.2); }
    .btn-primary:hover { background: var(--blue-700); }
    .btn-secondary { background: #f8fafc; color: #1e293b; border-color: #e2e8f0; }
    .btn-secondary:hover { background: #eef2ff; border-color: #c7d2fe; }

    .view { display: none; }
    .view--active { display: grid; gap: 20px; }

    /* Resource pool: horizontal large cards */
    .cards { margin-top: 14px; display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 14px;
      transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
      cursor: pointer;
      display: grid;
      gap: 12px;
    }
    .card:hover { box-shadow: 0 10px 22px rgba(15,23,42,.08); transform: translateY(-2px); border-color: #c7d2fe; }
    .card--expanded { border-color: #93c5fd; }
    .card-top { display: flex; gap: 14px; align-items: stretch; }
    .card-left { width: 280px; flex: 0 0 280px; display: grid; gap: 10px; }
    .card-head { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
    .card-name { font-size: 15px; font-weight: 900; line-height: 1.2; }
    .card-type { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .badge {
      font-size: 11px;
      font-weight: 800;
      color: var(--blue-700);
      background: var(--blue-50);
      border: 1px solid var(--panel-border);
      padding: 4px 8px;
      border-radius: 999px;
      flex: 0 0 auto;
    }
    .card-mid { flex: 1; min-width: 0; display: grid; align-content: start; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin-top: 4px; }
    .stat { background: var(--soft-bg); border: 1px solid #f1f5f9; border-radius: 8px; padding: 8px; }
    .stat-label { color: var(--muted); font-size: 11px; }
    .stat-value { margin-top: 2px; font-weight: 900; }
    .stat { min-height: 52px; }
    .error { margin-top: 8px; font-size: 12px; color: var(--rose); }

    .card-bottom {
      display: none;
      border-top: 1px dashed #e2e8f0;
      padding-top: 12px;
    }
    .card--expanded .card-bottom { display: block; }

    .details {
      font-size: 12px;
      color: #334155;
      display: grid;
      gap: 6px;
    }

    .gpu-item { margin-top: 6px; background: #fff; border: 1px solid #f1f5f9; border-radius: 8px; padding: 8px; font-size: 12px; }
    .gpu-title { font-weight: 800; }

    /* Eval layout */
    .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 1024px) { .analysis-grid { grid-template-columns: 3fr 7fr; } }
    .panel { display: flex; flex-direction: column; min-height: 420px; }
    .form { margin-top: 12px; display: grid; gap: 10px; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    select, input, textarea {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: #fff;
      color: var(--text);
      outline: none;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(147,197,253,.35);
    }
    .log-wrap { margin-top: 12px; flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .log-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .log-title { font-size: 12px; font-weight: 800; color: #334155; }
    .log-clear { background: none; border: none; font-size: 12px; color: var(--muted); cursor: pointer; }
    .log-clear:hover { color: var(--text); }
    .log-box {
      flex: 1;
      border: 1px solid var(--card-border);
      background: var(--soft-bg);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      line-height: 1.5;
      overflow: auto;
      white-space: pre-wrap;
      max-height: 260px;
    }
    .log-box::-webkit-scrollbar { width: 8px; height: 8px; }
    .log-box::-webkit-scrollbar-thumb { background: rgba(37,99,235,.45); border-radius: 8px; }
    .log-box::-webkit-scrollbar-track { background: transparent; }

    .ga-panel {
      margin-top: 12px;
      min-height: 420px;
      border: 1px dashed var(--card-border);
      border-radius: 8px;
      background: var(--soft-bg);
      display: block;
      color: var(--muted);
      padding: 16px;
      overflow: auto;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }
    .modal-backdrop.flex { display: flex; }
    .modal {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border: 1px solid #f1f5f9;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(15,23,42,.2);
    }
    .modal-head, .modal-foot {
      padding: 12px 14px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-foot { border-bottom: none; border-top: 1px solid #f1f5f9; justify-content: flex-end; }
    .modal-title { font-size: 14px; font-weight: 900; }
    .modal-close { background: none; border: none; font-size: 20px; color: var(--muted); cursor: pointer; line-height: 1; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 12px 14px; display: grid; gap: 10px; max-height: 70vh; overflow: auto; }
    .modal-body::-webkit-scrollbar { width: 8px; }
    .modal-body::-webkit-scrollbar-thumb { background: rgba(37,99,235,.35); border-radius: 8px; }
    .modal-body::-webkit-scrollbar-track { background: transparent; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    @media (max-width: 980px) {
      .layout { flex-direction: column; }
      .sidebar { width: auto; flex: 0 0 auto; height: auto; position: static; }
      .card-top { flex-direction: column; }
      .card-left { width: auto; flex: 0 0 auto; }
    }

    /* Algo run UI */
    .kv { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .kv-item { border: 1px solid var(--card-border); background: #fff; border-radius: 10px; padding: 10px; }
    .kv-label { font-size: 11px; color: var(--muted); font-weight: 800; }
    .kv-value { margin-top: 4px; font-size: 13px; font-weight: 900; }
    .progress { margin-top: 10px; height: 10px; border-radius: 999px; background: #e2e8f0; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; background: var(--blue-600); }
    .split { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 12px; }
    @media (min-width: 1024px) { .split { grid-template-columns: 1fr 1fr; } }
    .history-list { display: grid; gap: 10px; margin-top: 12px; }
    .history-grid { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 12px; }
    @media (min-width: 1024px) { .history-grid { grid-template-columns: 1fr 1.4fr; } }
    .history-scroll {
      border: 1px solid var(--card-border);
      background: var(--soft-bg);
      border-radius: 10px;
      padding: 10px;
      max-height: 520px;
      overflow: auto;
    }
    .history-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
    .history-scroll::-webkit-scrollbar-thumb { background: rgba(37,99,235,.35); border-radius: 8px; }
    .history-scroll::-webkit-scrollbar-track { background: transparent; }
    .history-item { border: 1px solid var(--card-border); background: #fff; border-radius: 10px; padding: 10px; cursor: pointer; }
    .history-item:hover { border-color: #bfdbfe; box-shadow: 0 6px 18px rgba(15,23,42,.06); }
    .history-item--active { border-color: #93c5fd; background: var(--blue-50); }
    .history-item-row { display: grid; grid-template-columns: 16px 1fr; gap: 10px; align-items: center; }
    .history-item-check { margin: 0; }
    .history-meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .history-actions { display: flex; gap: 8px; margin-top: 10px; }
    .server-multi-item {
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 8px 10px;
      background: #fff;
    }
    .server-multi-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .server-multi-toggle label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 0;
    }
    .server-multi-hint { font-size: 11px; color: var(--muted); }
    .server-multi-label {
      display: grid;
      grid-template-columns: 16px 1fr;
      align-items: center;
      gap: 10px;
      width: 100%;
    }
    .server-multi-check { margin: 0; }
    .server-multi-info { display: grid; gap: 2px; }
    .server-multi-name { font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .server-multi-sub { font-size: 11px; color: var(--muted); }
    .eval-steps { display: grid; gap: 10px; margin-bottom: 12px; }
    .eval-step { border: 1px dashed var(--card-border); border-radius: 12px; padding: 12px; background: var(--soft-bg); }
    .eval-step-title { font-weight: 900; margin-bottom: 8px; }
    .eval-step-actions { display: flex; gap: 8px; justify-content: space-between; margin-top: 12px; }
    .eval-step-actions .btn { min-width: 120px; }
    .eval-mode-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
    .eval-mode-card { border: 1px solid var(--card-border); border-radius: 10px; padding: 10px; background: #fff; }
    .eval-mode-card label { display: flex; align-items: flex-start; gap: 8px; font-size: 12px; color: var(--muted); }
    .eval-progress { margin-top: 10px; display: grid; gap: 6px; }
    .eval-progress-bar { height: 8px; background: #e2e8f0; border-radius: 999px; overflow: hidden; }
    .eval-progress-bar span { display: block; width: 40%; height: 100%; background: #2563eb; animation: evalpulse 1.2s ease-in-out infinite; }
    @keyframes evalpulse {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(250%); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <div class="brand">
        <img src="/static/assets/LOGO.png" alt="GAPA Logo" />
        <div>
          <div class="title">GAPA Console</div>
          <div class="subtitle">资源实时监控 · 算法运行与监控</div>
        </div>
      </div>
    </div>
  </header>

  <div class="container layout">
    <aside class="sidebar">
      <div class="nav-title">导航</div>
      <button class="nav-item nav-item--active" data-view="monitor"><span>资源池监控</span><span class="nav-badge">1</span></button>
      <button class="nav-item" data-view="algo"><span>算法运行与监控</span><span class="nav-badge">3</span></button>
      <button class="nav-item" data-view="config"><span>配置修改</span><span class="nav-badge">4</span></button>
      <button class="nav-item" data-view="history"><span>历史记录</span><span class="nav-badge">H</span></button>
      <div class="nav-title">提示</div>
      <div style="font-size:12px;color:var(--muted);padding:0 10px 10px;">
        资源卡片点击展开详情；详情区域支持滚动。
      </div>
    </aside>

    <main class="content">
      <!-- View 1: Monitor -->
      <div class="view view--active" id="view-monitor">
        <section class="section">
          <div class="section-header">
            <div class="section-title">资源池</div>
            <div>
              <button id="btn-lock" class="btn btn-primary">锁定空闲资源</button>
              <button id="btn-open-eval" class="btn btn-secondary">服务器测试评估</button>
              <button id="btn-refresh" class="btn btn-secondary">全部刷新</button>
            </div>
          </div>
          <div class="cards" id="cards">
            <div style="text-align:center;color:var(--muted);padding:28px 0;">正在加载本地资源…</div>
          </div>
          <div style="margin-top:16px;display:grid;gap:16px;">
            <div class="section panel">
              <div class="section-header">
                <div class="section-title">资源锁定状态</div>
                <div style="display:flex;gap:8px;">
                  <select id="lock-status-scope"></select>
                  <button id="btn-lock-status" class="btn btn-secondary">刷新状态</button>
                  <button id="btn-lock-release-now" class="btn" style="background:#fee2e2;color:#991b1b;border-color:#fecaca;">释放锁定</button>
                </div>
              </div>
              <div id="lock-status" style="margin-top:12px;display:grid;gap:10px;"></div>
              <div class="log-wrap">
                <div class="log-head">
                  <div class="log-title">锁定日志</div>
                  <button id="btn-lock-log-clear" class="log-clear">清空</button>
                </div>
                <div id="lock-log" class="log-box">暂无锁定操作。</div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- View 3: Algorithm run & monitor -->
      <div class="view" id="view-algo">
        <section class="section">
          <div class="section-header">
            <div class="section-title">算法运行与监控</div>
            <div style="font-size:12px;color:var(--muted);">提交任务 · 轮询状态 · 日志/结果可视化</div>
          </div>
          <div class="split">
            <div>
              <div class="form">
                <div>
                  <label>选择算法</label>
                  <select id="run-algo"></select>
                </div>
                <div>
                  <label>选择数据集</label>
                  <select id="run-dataset"></select>
                </div>
                <div>
                  <label>运行服务器</label>
                  <select id="run-server"></select>
                </div>
                <div>
                  <label>运行模式</label>
                  <select id="run-mode">
                    <option value="AUTO">默认（使用资源评估结果）</option>
                    <option value="CPU">CPU</option>
                    <option value="S">S（单卡）</option>
                    <option value="SM">SM（单卡加速）</option>
                    <option value="M">M（多卡）</option>
                    <option value="MNM">MNM（多机适应度加速）</option>
                  </select>
                </div>
                <div class="kv">
                  <div class="kv-item">
                    <div class="kv-label">资源锁定状态</div>
                    <div id="run-lock-status" class="kv-value">未知</div>
                    <div id="run-lock-detail" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
                  </div>
                  <div class="kv-item" style="display:grid;gap:8px;">
                    <button id="btn-run-lock-refresh" class="btn btn-secondary" style="width:100%;">刷新锁定</button>
                    <button id="btn-run-lock-release" class="btn" style="width:100%;background:#fee2e2;color:#991b1b;border-color:#fecaca;">释放锁定</button>
                  </div>
                </div>
                <div id="run-gpu-single-wrap" class="hidden">
                  <label>选择显卡（单选）</label>
                  <select id="run-gpu-single"></select>
                </div>
                <div id="run-gpu-multi-wrap" class="hidden">
                  <label>选择显卡（多选）</label>
                  <div id="run-gpu-multi" style="display:grid;gap:8px;"></div>
                </div>
                <div>
                  <label>迭代次数</label>
                  <input id="run-iters" type="number" min="1" value="20" />
                </div>
                <div class="row-2">
                  <div>
                    <label>交叉率 (pc)</label>
                    <input id="run-pc" type="number" min="0" max="1" step="0.01" value="0.80" />
                  </div>
                  <div>
                    <label>变异率 (pm)</label>
                    <input id="run-pm" type="number" min="0" max="1" step="0.01" value="0.20" />
                  </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                  <button id="btn-run" class="btn btn-primary" style="width:100%;">提交运行</button>
                  <button id="btn-run-stop" class="btn" style="width:100%;background:#fee2e2;color:#991b1b;border-color:#fecaca;" disabled>停止</button>
                </div>
              </div>

              <div class="kv">
                <div class="kv-item">
                  <div class="kv-label">状态</div>
                  <div id="run-state" class="kv-value">idle</div>
                </div>
                <div class="kv-item">
                  <div class="kv-label">任务ID</div>
                  <div id="run-taskid" class="kv-value">-</div>
                </div>
              </div>
              <div class="kv">
                <div class="kv-item">
                  <div class="kv-label">进度</div>
                  <div id="run-progress-text" class="kv-value">0%</div>
                  <div class="progress"><div id="run-progress" class="progress-bar"></div></div>
                </div>
                <div class="kv-item">
                  <div class="kv-label">最优值</div>
                  <div id="run-best" class="kv-value">-</div>
                </div>
              </div>
              <div class="kv">
                <div class="kv-item">
                  <div class="kv-label">通讯时间</div>
                  <div id="run-comm" class="kv-value">-</div>
                  <div id="run-comm-detail" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
                </div>
              </div>
            </div>

            <div>
              <div class="log-head" style="margin-top:0;">
                <div class="log-title">实时日志</div>
                <button id="btn-run-clear" class="log-clear">清空</button>
              </div>
              <div id="run-log" class="log-box" style="max-height:260px;">等待任务…</div>
              <div style="margin-top:12px;">
                <div class="log-title">结果可视化</div>
                <div id="run-chart" class="ga-panel" style="min-height:260px;">等待数据...</div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- View 4: Config -->
      <div class="view" id="view-config">
        <section class="section">
          <div class="section-header">
            <div class="section-title">配置修改</div>
            <div>
              <button id="btn-open-modal" class="btn btn-primary">+ 添加卡片节点</button>
            </div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px;line-height:1.6;">
            这里用于维护服务器节点配置（新增/编辑/移除）。当前版本：前端临时添加卡片节点（刷新页面后不持久化）。
          </div>
        </section>
      </div>

      <!-- View 5: History -->
      <div class="view" id="view-history">
        <section class="section">
          <div class="section-header">
            <div class="section-title">历史记录</div>
            <div class="history-actions">
              <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);">
                <input id="history-select-all" type="checkbox" />
                全选
              </label>
              <button id="btn-history-delete" class="btn btn-secondary" disabled>删除选中</button>
              <button id="btn-history-clear" class="btn btn-secondary">清空历史</button>
            </div>
          </div>
          <div class="history-grid">
            <div>
              <div class="log-title">记录列表</div>
              <div class="history-scroll">
                <div id="history-list" class="history-list"></div>
              </div>
            </div>
            <div>
              <div class="log-title">记录详情</div>
              <div id="history-detail" class="log-box" style="max-height:520px;">选择一条记录查看日志与指标。</div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Add Server Modal -->
  <div id="modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">添加服务器节点</div>
        <button id="btn-close-modal" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div>
          <label>IP 地址</label>
          <input id="modal-ip" placeholder="如 192.168.1.100" />
        </div>
        <div>
          <label>端口</label>
          <input id="modal-port" type="number" value="7777" />
        </div>
        <div class="row-2">
          <div>
            <label>用户名</label>
            <input id="modal-user" placeholder="可选" />
          </div>
          <div>
            <label>密码</label>
            <input id="modal-pass" type="password" placeholder="可选" />
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button id="btn-cancel" class="btn btn-secondary">取消</button>
        <button id="btn-add" class="btn btn-primary">添加</button>
      </div>
    </div>
  </div>

  <!-- Eval Modal -->
  <div id="eval-modal" class="modal-backdrop hidden">
    <div class="modal" style="max-width:820px;">
      <div class="modal-head">
        <div class="modal-title">服务器测试评估</div>
        <button id="btn-eval-close" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="eval-steps">
          <div class="eval-step" data-step="1">
            <div class="eval-step-title">步骤 1 · 选择评估模式</div>
            <div class="eval-mode-grid">
              <div class="eval-mode-card">
                <label>
                  <input type="radio" name="eval-mode" value="single" checked />
                  <span>
                    <div style="font-weight:900;color:var(--ink);">单服务器</div>
                    <div>仅评估一台服务器</div>
                  </span>
                </label>
              </div>
              <div class="eval-mode-card">
                <label>
                  <input type="radio" name="eval-mode" value="multi" />
                  <span>
                    <div style="font-weight:900;color:var(--ink);">多服务器</div>
                    <div>多台服务器对比或分布式</div>
                  </span>
                </label>
              </div>
            </div>
            <div class="eval-step-actions">
              <span></span>
              <button id="eval-next-1" class="btn btn-primary">下一步</button>
            </div>
          </div>

          <div class="eval-step hidden" data-step="2">
            <div class="eval-step-title">步骤 2 · 选择服务器</div>
            <div id="eval-single-wrap">
              <label>单服务器</label>
              <select id="select-server">
                <option value="local">本机</option>
              </select>
            </div>
            <div id="eval-multi-wrap" class="hidden" style="margin-top:10px;">
              <div class="server-multi-toggle">
                <label>
                  <input type="checkbox" id="select-server-multi" />
                  启用多机分布式加速
                </label>
                <span class="server-multi-hint">勾选后可选择多台服务器</span>
              </div>
              <select id="select-server-multi-mode" class="hidden">
                <option value="distributed">多机分布式加速（资源汇总）</option>
                <option value="compare">多台服务器对比</option>
              </select>
              <div id="select-server-multi-list" class="hidden" style="display:grid;gap:8px;margin-top:8px;"></div>
            </div>
            <div class="eval-step-actions">
              <button id="eval-prev-2" class="btn btn-secondary">上一步</button>
              <button id="eval-next-2" class="btn btn-primary">下一步</button>
            </div>
          </div>

          <div class="eval-step hidden" data-step="3">
            <div class="eval-step-title">步骤 3 · 选择算法并开始评估</div>
            <div class="form" style="margin-top:0;">
              <div>
                <label>选择算法</label>
                <select id="select-algo">
                  <option value="monitor" data-kind="monitor">仅监控资源</option>
                </select>
              </div>
              <div>
                <label>选择数据集</label>
                <select id="select-dataset"></select>
              </div>
              <div id="warmup-wrap" class="hidden">
                <label>Warm up 次数</label>
                <input id="input-warmup" type="number" min="0" value="2" />
              </div>
              <button id="btn-analyze" class="btn btn-primary" style="width:100%;">开始分析</button>
              <button id="btn-analyze-lock" class="btn btn-secondary" style="width:100%;" disabled>设置为资源锁定策略</button>
            </div>

            <div class="log-wrap" style="margin-top:12px;">
              <div class="log-head">
                <div class="log-title">分析日志</div>
                <button id="btn-clear-log" class="log-clear">清空</button>
              </div>
              <div id="log-box" class="log-box">等待操作…</div>
            </div>

            <div style="margin-top:12px;">
              <div class="log-title">遗传算法分析</div>
              <div id="ga-panel" class="ga-panel">等待数据...</div>
            </div>
            <div id="eval-progress" class="eval-progress hidden">
              <div style="font-size:12px;color:var(--muted);">评估进行中，请稍候…</div>
              <div class="eval-progress-bar"><span></span></div>
            </div>
            <div class="eval-step-actions">
              <button id="eval-prev-3" class="btn btn-secondary">上一步</button>
              <span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Resource Lock Modal -->
  <div id="lock-modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">资源锁定</div>
        <button id="lock-close" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div>
          <label>锁定模式</label>
          <select id="lock-mode">
            <option value="auto">自动锁定（推荐）</option>
            <option value="manual">手动锁定</option>
          </select>
        </div>
        <div>
          <label>锁定范围</label>
          <select id="lock-scope"></select>
        </div>
        <div class="row-2">
          <div>
            <label>锁定时长（秒）</label>
            <input id="lock-duration" type="number" min="10" value="600" />
          </div>
          <div id="lock-warmup-wrap">
            <label>Warm up 次数</label>
            <input id="lock-warmup" type="number" min="0" value="2" />
          </div>
        </div>
        <div id="lock-manual-wrap" class="hidden">
          <label>选择显卡（手动）</label>
          <div id="lock-server-list" style="display:grid;gap:12px;"></div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px;">
            手动锁定支持选择多个服务器，并分别选择显卡。
          </div>
        </div>
        <div>
          <label>显存占用（MB）</label>
          <input id="lock-mem" type="number" min="0" value="1024" />
        </div>
      </div>
      <div class="modal-foot">
        <button id="lock-release" class="btn btn-secondary">释放锁定</button>
        <button id="lock-apply" class="btn btn-primary">开始锁定</button>
      </div>
    </div>
  </div>

  <script>
    function setActiveView(view) {
      document.querySelectorAll(".nav-item").forEach((btn) => {
        btn.classList.toggle("nav-item--active", btn.dataset.view === view);
      });
      document.querySelectorAll(".view").forEach((v) => {
        v.classList.toggle("view--active", v.id === `view-${view}`);
      });
      try { localStorage.setItem("gapa_view", view); } catch (e) {}
    }

    document.querySelectorAll(".nav-item").forEach((btn) => {
      btn.addEventListener("click", () => setActiveView(btn.dataset.view));
    });
    try {
      const saved = localStorage.getItem("gapa_view");
      if (saved && document.getElementById(`view-${saved}`)) {
        setActiveView(saved);
      } else {
        setActiveView("monitor");
      }
    } catch (e) {}

    const cardsDiv = document.getElementById("cards");
    const serverSelect = document.getElementById("select-server");
    const serverSelectMulti = document.getElementById("select-server-multi");
    const serverSelectMultiMode = document.getElementById("select-server-multi-mode");
    const serverSelectMultiList = document.getElementById("select-server-multi-list");
    const algoSelect = document.getElementById("select-algo");
    const evalDataset = document.getElementById("select-dataset");
    const warmupWrap = document.getElementById("warmup-wrap");
    const warmupInput = document.getElementById("input-warmup");
    const logBox = document.getElementById("log-box");
    const gaPanel = document.getElementById("ga-panel");

    const modal = document.getElementById("modal");
    const btnOpenModal = document.getElementById("btn-open-modal");
    const btnCloseModal = document.getElementById("btn-close-modal");
    const btnCancel = document.getElementById("btn-cancel");
    const btnAdd = document.getElementById("btn-add");
    const evalModal = document.getElementById("eval-modal");
    const btnOpenEval = document.getElementById("btn-open-eval");
    const btnEvalClose = document.getElementById("btn-eval-close");
    const evalNext1 = document.getElementById("eval-next-1");
    const evalNext2 = document.getElementById("eval-next-2");
    const evalPrev2 = document.getElementById("eval-prev-2");
    const evalPrev3 = document.getElementById("eval-prev-3");
    const evalSingleWrap = document.getElementById("eval-single-wrap");
    const evalMultiWrap = document.getElementById("eval-multi-wrap");
    const evalProgress = document.getElementById("eval-progress");
    const btnLock = document.getElementById("btn-lock");
    const lockModal = document.getElementById("lock-modal");
    const lockClose = document.getElementById("lock-close");
    const lockMode = document.getElementById("lock-mode");
    const lockScope = document.getElementById("lock-scope");
    const lockDuration = document.getElementById("lock-duration");
    const lockWarmup = document.getElementById("lock-warmup");
    const lockWarmupWrap = document.getElementById("lock-warmup-wrap");
    const lockMem = document.getElementById("lock-mem");
    const lockManualWrap = document.getElementById("lock-manual-wrap");
    const lockServerList = document.getElementById("lock-server-list");
    const lockApply = document.getElementById("lock-apply");
    const lockRelease = document.getElementById("lock-release");
    const lockStatusScope = document.getElementById("lock-status-scope");
    const lockStatusBox = document.getElementById("lock-status");
    const lockLogBox = document.getElementById("lock-log");
    const btnLockStatus = document.getElementById("btn-lock-status");
    const btnLockReleaseNow = document.getElementById("btn-lock-release-now");
    const btnLockLogClear = document.getElementById("btn-lock-log-clear");

    const sources = [{ id: "local", base: "", label: "本机", expanded: true, meta: { type: "local" } }];
    const snapshots = new Map();

    // Algo run DOM
    let RUN_SERVER_ID = "local";
    const runServer = document.getElementById("run-server");
    const runAlgo = document.getElementById("run-algo");
    const runDataset = document.getElementById("run-dataset");
    const runMode = document.getElementById("run-mode");
    const runGpuSingleWrap = document.getElementById("run-gpu-single-wrap");
    const runGpuSingle = document.getElementById("run-gpu-single");
    const runGpuMultiWrap = document.getElementById("run-gpu-multi-wrap");
    const runGpuMulti = document.getElementById("run-gpu-multi");
    const runIters = document.getElementById("run-iters");
    const runPc = document.getElementById("run-pc");
    const runPm = document.getElementById("run-pm");
    const btnRun = document.getElementById("btn-run");
    const btnRunStop = document.getElementById("btn-run-stop");
    const runState = document.getElementById("run-state");
    const runTaskId = document.getElementById("run-taskid");
    const runProgress = document.getElementById("run-progress");
    const runProgressText = document.getElementById("run-progress-text");
    const runBest = document.getElementById("run-best");
    const runComm = document.getElementById("run-comm");
    const runCommDetail = document.getElementById("run-comm-detail");
    const runLog = document.getElementById("run-log");
    const runChart = document.getElementById("run-chart");
    const btnRunClear = document.getElementById("btn-run-clear");
    const runLockStatus = document.getElementById("run-lock-status");
    const runLockDetail = document.getElementById("run-lock-detail");
    const btnRunLockRefresh = document.getElementById("btn-run-lock-refresh");
    const btnRunLockRelease = document.getElementById("btn-run-lock-release");
    const btnAnalyzeLock = document.getElementById("btn-analyze-lock");
    const RUN_CONFIG_KEY = "gapa_run_config_v1";

    // History DOM
    const historyList = document.getElementById("history-list");
    const historyDetail = document.getElementById("history-detail");
    const btnHistoryClear = document.getElementById("btn-history-clear");
    const btnHistoryDelete = document.getElementById("btn-history-delete");
    const historySelectAll = document.getElementById("history-select-all");
    const PLAN_KEY = "gapa_saved_plans_v1";
    let datasetsManifest = null;
    let lastEvalPlan = null;
    let lastEvalMode = null; // "single" | "distributed"
    let lastEvalTarget = null;
    let currentPoll = null;
    let lastLogCount = 0;

    function fmt(val, unit = "", fallback = "N/A") {
      return val == null ? fallback : `${val}${unit}`;
    }
    function pct(val) {
      return val == null ? "N/A" : `${Number(val).toFixed(1)}%`;
    }
    function log(line) {
      const ts = new Date().toLocaleTimeString();
      const next = `[${ts}] ${line}\n`;
      if (logBox.textContent.trim() === "等待操作…") logBox.textContent = "";
      logBox.textContent += next;
      logBox.scrollTop = logBox.scrollHeight;
    }
    function lockLog(line) {
      if (!lockLogBox) return;
      const ts = new Date().toLocaleTimeString();
      const next = `[${ts}] ${line}\n`;
      if (lockLogBox.textContent.trim() === "暂无锁定操作。") lockLogBox.textContent = "";
      lockLogBox.textContent += next;
      lockLogBox.scrollTop = lockLogBox.scrollHeight;
    }

    function openModal() {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      document.getElementById("modal-ip").focus();
    }
    function closeModal() {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.getElementById("modal-ip").value = "";
      document.getElementById("modal-port").value = "7777";
      document.getElementById("modal-user").value = "";
      document.getElementById("modal-pass").value = "";
    }

    function openEvalModal() {
      if (!evalModal) return;
      evalModal.classList.remove("hidden");
      evalModal.classList.add("flex");
      setEvalStep(1);
    }
    function closeEvalModal() {
      if (!evalModal) return;
      evalModal.classList.add("hidden");
      evalModal.classList.remove("flex");
    }
    let evalStep = 1;
    function currentEvalMode() {
      const el = document.querySelector('input[name="eval-mode"]:checked');
      return el ? el.value : "single";
    }
    function updateEvalModeUI() {
      const mode = currentEvalMode();
      const multiEnabled = mode === "multi";
      if (evalSingleWrap) evalSingleWrap.classList.toggle("hidden", multiEnabled);
      if (evalMultiWrap) evalMultiWrap.classList.toggle("hidden", !multiEnabled);
      if (serverSelectMulti) {
        serverSelectMulti.checked = multiEnabled;
        serverSelectMulti.dispatchEvent(new Event("change"));
      }
    }
    function setEvalStep(step) {
      evalStep = step;
      evalModal?.querySelectorAll(".eval-step").forEach((el) => {
        el.classList.toggle("hidden", Number(el.dataset.step) !== step);
      });
      if (step === 2) updateEvalModeUI();
    }

    function openLockModal() {
      lockModal.classList.remove("hidden");
      lockModal.classList.add("flex");
      updateLockModeVisibility();
      lockScope.focus();
    }
    function closeLockModal() {
      lockModal.classList.add("hidden");
      lockModal.classList.remove("flex");
    }

    btnOpenModal.addEventListener("click", openModal);
    btnCloseModal.addEventListener("click", closeModal);
    btnCancel.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });
    btnOpenEval?.addEventListener("click", openEvalModal);
    btnEvalClose?.addEventListener("click", closeEvalModal);
    evalModal?.addEventListener("click", (e) => {
      if (e.target === evalModal) closeEvalModal();
    });
    evalNext1?.addEventListener("click", () => setEvalStep(2));
    evalNext2?.addEventListener("click", () => setEvalStep(3));
    evalPrev2?.addEventListener("click", () => setEvalStep(1));
    evalPrev3?.addEventListener("click", () => setEvalStep(2));
    document.querySelectorAll('input[name="eval-mode"]').forEach((el) => {
      el.addEventListener("change", updateEvalModeUI);
    });
    btnLock?.addEventListener("click", openLockModal);
    lockClose?.addEventListener("click", closeLockModal);

    document.getElementById("btn-clear-log").addEventListener("click", () => {
      logBox.textContent = "";
    });
    btnLockLogClear?.addEventListener("click", () => {
      if (lockLogBox) lockLogBox.textContent = "";
    });

    function updateServerSelect() {
      const current = serverSelect.value;
      serverSelect.innerHTML = sources.map((s) => `<option value="${s.id}">${s.label}</option>`).join("");
      serverSelect.value = sources.some((s) => s.id === current) ? current : "local";
      updateRunGpuOptions();
    }

    function updateServerMultiList() {
      if (!serverSelectMultiList) return;
      serverSelectMultiList.innerHTML = sources
        .map((s) => {
          const snap = snapshots.get(s.id) || {};
          const gpus = Array.isArray(snap.gpus) ? snap.gpus : [];
          return `
            <div class="server-multi-item">
              <label class="server-multi-label">
                <input type="checkbox" class="server-multi-check" value="${s.id}" />
                <div class="server-multi-info">
                  <div class="server-multi-name">${s.label}</div>
                  <div class="server-multi-sub">GPU ${gpus.length} 张</div>
                </div>
              </label>
            </div>
          `;
        })
        .join("");
    }

    function updateLockScopeOptions() {
      if (!lockScope) return;
      const opts = [{ id: "all", label: "所有服务器" }, ...sources.map((s) => ({ id: s.id, label: s.label }))];
      const current = lockScope.value;
      lockScope.innerHTML = opts.map((o) => `<option value="${o.id}">${o.label}</option>`).join("");
      lockScope.value = opts.some((o) => o.id === current) ? current : "all";
      if (lockStatusScope) {
        const cur = lockStatusScope.value;
        lockStatusScope.innerHTML = opts.map((o) => `<option value="${o.id}">${o.label}</option>`).join("");
        lockStatusScope.value = opts.some((o) => o.id === cur) ? cur : "all";
      }
    }

    function updateLockManualOptions() {
      if (!lockServerList) return;
      const scope = lockScope?.value || "all";
      const targets = scope === "all" ? sources : sources.filter((s) => s.id === scope);
      if (!targets.length) {
        lockServerList.innerHTML = `<div style="font-size:12px;color:var(--muted);">未找到可用服务器</div>`;
        return;
      }
      lockServerList.innerHTML = targets
        .map((s) => {
          const snap = snapshots.get(s.id) || {};
          const gpus = Array.isArray(snap.gpus) ? snap.gpus : [];
          const gpuHtml = gpus.length
            ? gpus
                .map((g) => {
                  const label = g.name ? `${g.name} (#${g.id})` : `GPU ${g.id}`;
                  return `
                    <label style="display:flex;gap:10px;align-items:center;border:1px solid var(--card-border);border-radius:10px;padding:8px;background:#fff;">
                      <input type="checkbox" class="lock-gpu-check" data-server="${s.id}" value="${g.id}" />
                      <span style="font-weight:900;">${label}</span>
                    </label>
                  `;
                })
                .join("")
            : `<div style="font-size:12px;color:var(--muted);">无 GPU</div>`;
          return `
            <div style="border:1px solid var(--card-border);border-radius:10px;padding:10px;background:#f8fafc;">
              <div style="font-weight:900;margin-bottom:8px;">${s.label}</div>
              <div style="display:grid;gap:8px;">${gpuHtml}</div>
            </div>
          `;
        })
        .join("");
    }

    function updateLockModeVisibility() {
      const mode = (lockMode?.value || "auto").toLowerCase();
      const isManual = mode === "manual";
      lockWarmupWrap?.classList.toggle("hidden", isManual);
      lockManualWrap?.classList.toggle("hidden", !isManual);
      if (isManual) updateLockManualOptions();
    }

    function formatExpire(ts) {
      if (!ts) return "-";
      try {
        const d = new Date(ts * 1000);
        return d.toLocaleString();
      } catch (e) {
        return "-";
      }
    }

    function renderLockStatus(data) {
      if (!lockStatusBox) return;
      const results = (data && data.results) || {};
      const entries = Object.entries(results);
      if (!entries.length) {
        lockStatusBox.innerHTML = `<div style="font-size:12px;color:var(--muted);">暂无锁定状态。</div>`;
        return;
      }
      lockStatusBox.innerHTML = entries
        .map(([sid, info]) => {
          if (info?.error) {
            return `<div class="stat" style="border-color:#fecaca;background:#fef2f2;">
              <div class="stat-label">${sid}</div>
              <div class="stat-value">错误：${info.error}</div>
            </div>`;
          }
          const active = info?.active ? "已锁定" : "未锁定";
          const backend = info?.backend || "-";
          const devices = Array.isArray(info?.devices) ? info.devices.join(",") : "-";
          const exp = formatExpire(info?.expires_at || 0);
          const mem = info?.mem_mb != null ? `${info.mem_mb} MB` : "-";
          const warm = info?.warmup_iters != null ? `${info.warmup_iters}` : "-";
          return `
            <div class="stat" style="min-height:auto;">
              <div class="stat-label">${sid}</div>
              <div class="stat-value">${active}</div>
              <div style="font-size:11px;color:var(--muted);margin-top:4px;">
                backend=${backend} devices=${devices} expires=${exp} mem=${mem} warmup=${warm}
                ${info?.note === "no_available_gpu" ? " · 无空闲GPU，已跳过锁定" : ""}
              </div>
            </div>
          `;
        })
        .join("");
    }

    async function fetchLockStatus(scope) {
      const target = scope || (lockStatusScope?.value || "all");
      try {
        const resp = await fetch(`/api/resource_lock/status?scope=${encodeURIComponent(target)}`, { cache: "no-store" });
        const data = await resp.json();
        if (!resp.ok) {
          lockLog(`锁定状态获取失败: ${JSON.stringify(data)}`);
          return;
        }
        renderLockStatus(data);
      } catch (e) {
        lockLog(`锁定状态获取失败: ${e}`);
      }
    }

    function plansLoad() {
      try { return JSON.parse(localStorage.getItem(PLAN_KEY) || "{}") || {}; } catch (e) { return {}; }
    }
    function plansSave(obj) {
      try { localStorage.setItem(PLAN_KEY, JSON.stringify(obj)); } catch (e) {}
    }
    function getSavedPlan(server_id) {
      const all = plansLoad();
      return all[server_id] || null;
    }
    function setSavedPlan(server_id, plan) {
      const all = plansLoad();
      all[server_id] = { plan, saved_at: new Date().toLocaleString() };
      plansSave(all);
    }

    function updateRunGpuOptions() {
      const sid = RUN_SERVER_ID;
      if (sid === "all") {
        if (runGpuSingle) runGpuSingle.innerHTML = "";
        if (runGpuMulti) runGpuMulti.innerHTML = "";
        return;
      }
      const snap = snapshots.get(sid) || {};
      const gpus = Array.isArray(snap.gpus) ? snap.gpus : [];
      const options = gpus.map((g) => ({ id: g.id, name: g.name || `GPU ${g.id}` }));

      if (runGpuSingle) {
        runGpuSingle.innerHTML = options.map((o) => `<option value="${o.id}">${o.name} (#${o.id})</option>`).join("");
      }
      if (runGpuMulti) {
        runGpuMulti.innerHTML = options
          .map((o) => {
            return `
              <label style="display:flex;gap:10px;align-items:center;border:1px solid var(--card-border);border-radius:10px;padding:8px;background:#fff;">
                <input type="checkbox" class="run-gpu-check" value="${o.id}" />
                <span style="font-weight:900;">${o.name}</span>
                <span style="color:var(--muted);font-size:12px;">#${o.id}</span>
              </label>
            `;
          })
          .join("");
      }

      // Apply default selection from saved plan for AUTO
      const saved = getSavedPlan(sid);
      if (saved && saved.plan && Array.isArray(saved.plan.devices) && saved.plan.devices.length) {
        const devs = saved.plan.devices.map((x) => Number(x));
        if (runGpuSingle && devs.length) runGpuSingle.value = String(devs[0]);
        if (runGpuMulti) {
          runGpuMulti.querySelectorAll(".run-gpu-check").forEach((el) => {
            el.checked = devs.includes(Number(el.value));
          });
        }
      }
    }

    function updateRunServerOptions(lockResults) {
      if (!runServer) return;
      const results = lockResults || {};
      const locked = Object.keys(results).filter((k) => results[k]?.active);
      const remoteLocked = locked.filter((k) => k !== "local");
      const opts = [];
      opts.push({ id: "all", label: "默认（所有服务器）" });
      if (results.local?.active || locked.length === 0) {
        opts.push({ id: "local", label: (sources.find((s) => s.id === "local") || {}).label || "本机" });
      }
      remoteLocked.forEach((sid) => {
        const src = sources.find((s) => s.id === sid);
        opts.push({ id: sid, label: src?.label || sid });
      });
      const current = runServer.value || RUN_SERVER_ID;
      runServer.innerHTML = opts.map((o) => `<option value="${o.id}">${o.label}</option>`).join("");
      runServer.value = opts.some((o) => o.id === current) ? current : opts[0].id;
      RUN_SERVER_ID = runServer.value;
      updateRunModeOptions();
      updateRunGpuOptions();
      updateRunModeVisibility();
    }

    function updateRunModeOptions() {
      if (!runMode) return;
      const sid = runServer?.value || RUN_SERVER_ID;
      const snap = snapshots.get(sid) || {};
      const hasGpu = Array.isArray(snap.gpus) && snap.gpus.length > 0;
      let opts = [];
      if (sid === "all") {
        opts = [
          { id: "AUTO", label: "默认（使用资源评估结果）" },
          { id: "MNM", label: "MNM（多机适应度加速）" },
        ];
      } else if (!hasGpu) {
        opts = [{ id: "S", label: "S（单卡）" }];
      } else {
        opts = [
          { id: "S", label: "S（单卡）" },
          { id: "SM", label: "SM（单卡加速）" },
          { id: "M", label: "M（多卡）" },
        ];
      }
      const current = runMode.value || "AUTO";
      runMode.innerHTML = opts.map((o) => `<option value="${o.id}">${o.label}</option>`).join("");
      runMode.value = opts.some((o) => o.id === current) ? current : opts[0].id;
    }

    function updateRunModeVisibility() {
      const mode = (runMode?.value || "AUTO").toUpperCase();
      const sid = RUN_SERVER_ID;
      if (sid === "all") {
        runGpuSingleWrap?.classList.add("hidden");
        runGpuMultiWrap?.classList.add("hidden");
        return;
      }
      const snap = snapshots.get(sid) || {};
      const hasGpu = Array.isArray(snap.gpus) && snap.gpus.length > 0;

      const single = mode === "S" || mode === "SM";
      const multi = mode === "M" || mode === "MNM";
      runGpuSingleWrap?.classList.toggle("hidden", !(single && hasGpu));
      runGpuMultiWrap?.classList.toggle("hidden", !(multi && hasGpu));
    }
    runMode?.addEventListener("change", updateRunModeVisibility);
    runMode?.addEventListener("change", updateRunModeVisibility);
    runServer?.addEventListener("change", () => {
      RUN_SERVER_ID = runServer.value;
      updateRunModeOptions();
      updateRunGpuOptions();
      updateRunModeVisibility();
      refreshRunLockStatus();
      saveRunConfig();
    });

    function saveRunConfig() {
      if (!runAlgo) return;
      try {
        const multi = runGpuMulti
          ? Array.from(runGpuMulti.querySelectorAll(".run-gpu-check") || [])
              .filter((el) => el.checked)
              .map((el) => String(el.value))
          : [];
        const payload = {
          runAlgo: runAlgo.value,
          runDataset: runDataset?.value || "",
          runServer: runServer?.value || RUN_SERVER_ID,
          runMode: runMode?.value || "AUTO",
          runGpuSingle: runGpuSingle?.value || "",
          runGpuMulti: multi,
          runIters: runIters?.value || "",
          runPc: runPc?.value || "",
          runPm: runPm?.value || "",
        };
        localStorage.setItem(RUN_CONFIG_KEY, JSON.stringify(payload));
      } catch (e) {}
    }

    function applyRunConfig() {
      if (!runAlgo) return;
      let cfg = null;
      try {
        cfg = JSON.parse(localStorage.getItem(RUN_CONFIG_KEY) || "null");
      } catch (e) {
        cfg = null;
      }
      if (!cfg) return;
      if (cfg.runAlgo && runAlgo.querySelector(`option[value="${cfg.runAlgo}"]`)) {
        runAlgo.value = cfg.runAlgo;
      }
      updateRunDatasetOptions();
      if (cfg.runDataset && runDataset?.querySelector(`option[value="${cfg.runDataset}"]`)) {
        runDataset.value = cfg.runDataset;
      }
      if (cfg.runServer && runServer?.querySelector(`option[value="${cfg.runServer}"]`)) {
        runServer.value = cfg.runServer;
        RUN_SERVER_ID = cfg.runServer;
      }
      updateRunModeOptions();
      if (cfg.runMode && runMode?.querySelector(`option[value="${cfg.runMode}"]`)) {
        runMode.value = cfg.runMode;
      }
      updateRunGpuOptions();
      updateRunModeVisibility();
      if (cfg.runGpuSingle && runGpuSingle?.querySelector(`option[value="${cfg.runGpuSingle}"]`)) {
        runGpuSingle.value = cfg.runGpuSingle;
      }
      if (Array.isArray(cfg.runGpuMulti) && runGpuMulti) {
        const want = new Set(cfg.runGpuMulti.map((v) => String(v)));
        runGpuMulti.querySelectorAll(".run-gpu-check").forEach((el) => {
          el.checked = want.has(String(el.value));
        });
      }
      if (cfg.runIters && runIters) runIters.value = cfg.runIters;
      if (cfg.runPc && runPc) runPc.value = cfg.runPc;
      if (cfg.runPm && runPm) runPm.value = cfg.runPm;
    }

    runAlgo?.addEventListener("change", () => {
      updateRunDatasetOptions();
      saveRunConfig();
    });
    runDataset?.addEventListener("change", saveRunConfig);
    runMode?.addEventListener("change", saveRunConfig);
    runGpuSingle?.addEventListener("change", saveRunConfig);
    runGpuMulti?.addEventListener("change", saveRunConfig);
    runIters?.addEventListener("change", saveRunConfig);
    runPc?.addEventListener("change", saveRunConfig);
    runPm?.addEventListener("change", saveRunConfig);

    btnAdd.addEventListener("click", () => {
      const ip = document.getElementById("modal-ip").value.trim();
      const port = document.getElementById("modal-port").value.trim() || "7777";
      const username = document.getElementById("modal-user").value.trim();
      const password = document.getElementById("modal-pass").value;
      if (!ip) return alert("请填写IP地址");
      const base = `http://${ip}:${port}`;
      const id = `${ip}-${port}`;
      if (sources.some((s) => s.id === id)) return alert("已添加该服务器");
      sources.push({ id, base, label: `${ip}:${port}`, expanded: false, meta: { type: "remote", username, password } });
      updateServerSelect();
      updateLockScopeOptions();
      closeModal();
      log(`已添加服务器 ${id}`);

      // Immediate feedback for the newly added server
      const added = sources.find((s) => s.id === id);
      if (added) {
        fetchFrom(added).then((data) => {
          snapshots.set(id, data || {});
          if (data?.error) {
            log(`服务器 ${id} 连接失败：${data.error}`);
            log(`请确认远程已启动 server_agent，并监听 ${port}（以及防火墙放通）。`);
          }
          render();
        });
      }
      refreshAll();
    });

    async function loadConfigServers() {
      try {
        const res = await fetch("/api/servers", { cache: "no-store" });
        if (!res.ok) return;
        const list = await res.json();
        list.forEach((item) => {
          if (!item.ip) return;
          const id = item.id || `${item.ip}-${item.port || "default"}`;
          if (sources.some((s) => s.id === id)) return;
          const protocol = item.protocol || "http";
          const base = `${protocol}://${item.ip}${item.port ? ":" + item.port : ""}`;
          sources.push({ id, base, label: item.name || `${item.ip}:${item.port || ""}`, expanded: false, meta: { type: item.type, username: item.username } });
        });
        updateServerSelect();
        updateLockScopeOptions();
      } catch (e) {
        console.warn("load servers failed", e);
      }
    }

    lockMode?.addEventListener("change", updateLockModeVisibility);
    lockScope?.addEventListener("change", () => {
      updateLockManualOptions();
      updateLockModeVisibility();
    });
    serverSelectMulti?.addEventListener("change", () => {
      const enabled = !!serverSelectMulti.checked;
      serverSelectMultiList?.classList.toggle("hidden", !enabled);
      serverSelectMultiMode?.classList.toggle("hidden", !enabled);
      if (enabled) updateServerMultiList();
      if (serverSelect) serverSelect.disabled = enabled;
    });

    async function loadAlgorithms() {
      try {
        const res = await fetch("/api/algorithms", { cache: "no-store" });
        if (!res.ok) return;
        const list = await res.json();
        const opts = [{ id: "monitor", name: "仅监控资源", kind: "monitor" }, ...(Array.isArray(list) ? list : [])];
        algoSelect.innerHTML = opts
          .map((o) => {
            const disabled = o.disabled ? "disabled" : "";
            const label = o.name || o.id;
            const kind = o.kind || "ga";
            return `<option value="${o.id}" data-kind="${kind}" ${disabled}>${label}</option>`;
          })
          .join("");
        if (runAlgo) {
          const runOpts = opts.filter((o) => o.id !== "monitor");
          runAlgo.innerHTML = runOpts
            .map((o) => {
              const disabled = o.disabled ? "disabled" : "";
              const label = o.name || o.id;
              return `<option value="${o.id}" ${disabled}>${label}</option>`;
            })
            .join("");
        }
      } catch (e) {
        console.warn("load algorithms failed", e);
      }
    }

    async function loadDatasets() {
      try {
        const res = await fetch("/api/datasets", { cache: "no-store" });
        if (!res.ok) return;
        datasetsManifest = await res.json();
      } catch (e) {
        datasetsManifest = null;
      }
    }

    function updateRunDatasetOptions() {
      if (!runDataset) return;
      const algo = runAlgo?.value;
      const byAlgo = datasetsManifest?.by_algorithm || {};
      const list = Array.isArray(byAlgo?.[algo]) ? byAlgo[algo] : [];
      if (!list.length) {
        runDataset.innerHTML = `<option value="">(该算法暂无数据集清单)</option>`;
        return;
      }
      runDataset.innerHTML = list.map((d) => `<option value="${d}">${d}</option>`).join("");
    }

    function updateEvalDatasetOptions() {
      if (!evalDataset) return;
      const algo = algoSelect?.value;
      const byAlgo = datasetsManifest?.by_algorithm || {};
      const list = Array.isArray(byAlgo?.[algo]) ? byAlgo[algo] : [];
      if (!list.length) {
        evalDataset.innerHTML = `<option value="">(该算法暂无数据集清单)</option>`;
        return;
      }
      evalDataset.innerHTML = list.map((d) => `<option value="${d}">${d}</option>`).join("");
    }

    algoSelect.addEventListener("change", () => {
      const sel = algoSelect.selectedOptions[0];
      const kind = sel?.dataset?.kind || (algoSelect.value === "monitor" ? "monitor" : "ga");
      warmupWrap.classList.toggle("hidden", kind === "monitor");
      if (evalDataset) evalDataset.disabled = kind === "monitor";
      updateEvalDatasetOptions();
    });

    runAlgo?.addEventListener("change", updateRunDatasetOptions);

    async function fetchFrom(source) {
      try {
        const url = source.base ? `${source.base}/api/resources` : "/api/resources";
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(res.status);
        return await res.json();
      } catch (e) {
        return { error: "连接失败或无响应", hostname: source.label };
      }
    }

    function render() {
      cardsDiv.innerHTML = sources
        .map((src) => {
          const data = snapshots.get(src.id) || {};
          const gpus = data.gpus || [];
          const cpu = data.cpu || {};
          const mem = data.memory || {};
          const expanded = !!src.expanded;

          const title = data.name || src.label || data.hostname || src.id;
          const gpuHtml = gpus.length
            ? gpus
                .map(
                  (g) => `
                  <div class="gpu-item">
                    <div class="gpu-title">GPU ${g.id} · ${g.name}</div>
                    <div style="color:var(--muted);margin-top:2px;">
                      显存：${fmt(g.used_mb)} / ${fmt(g.total_mb)} MB（功率 ${fmt(g.power_w, " W")}）
                    </div>
                    <div style="color:var(--muted);margin-top:2px;">
                      GPU 利用率：${fmt(g.gpu_util_percent, "%")} · 显存利用率：${fmt(g.mem_util_percent, "%")}
                    </div>
                  </div>`
                )
                .join("")
            : `<div style="font-size:12px;color:var(--muted);margin-top:6px;">无GPU信息</div>`;

          return `
            <div class="card ${expanded ? "card--expanded" : ""}" onclick="toggle('${src.id}')">
              <div class="card-top">
                <div class="card-left">
                  <div class="card-head">
                    <div>
                      <div class="card-name">${title}</div>
                      <div class="card-type">${src.meta?.type === "local" ? "本地机器" : src.meta?.type || "远程服务器"}</div>
                    </div>
                    <div class="badge">${data.time || data.timestamp || "--"}</div>
                  </div>
                  <div style="font-size:12px;color:var(--muted);">
                    Host: ${data.hostname || "N/A"}
                  </div>
                </div>

                <div class="card-mid">
                  <div class="stats">
                    <div class="stat">
                      <div class="stat-label">CPU 负载</div>
                      <div class="stat-value">${pct(cpu.usage_percent)}</div>
                    </div>
                    <div class="stat">
                      <div class="stat-label">内存占用</div>
                      <div class="stat-value">${pct(mem.percent)}</div>
                    </div>
                    <div class="stat">
                      <div class="stat-label">显卡数量</div>
                      <div class="stat-value">${gpus.length} 张</div>
                    </div>
                  </div>
                  ${data.error ? `<div class="error">错误：${data.error}</div>` : ""}
                </div>
              </div>

              <div class="card-bottom">
                <div class="details">
                  <div>CPU 负载均值：${fmt(cpu.load_avg?.[0], "", "N/A")}</div>
                  <div>内存：${fmt(mem.used_mb)} / ${fmt(mem.total_mb)} MB</div>
                  ${src.meta?.username ? `<div>用户：${src.meta.username}</div>` : ""}
                  ${gpuHtml}
                </div>
              </div>
            </div>
          `;
        })
        .join("");
    }

    function toggle(id) {
      const s = sources.find((x) => x.id === id);
      if (s) s.expanded = !s.expanded;
      render();
    }

    async function refreshAll() {
      try {
        const resp = await fetch("/api/all_resources", { cache: "no-store" });
        const all = await resp.json();
        Object.entries(all).forEach(([id, data]) => snapshots.set(id, data || {}));
        render();
        updateRunGpuOptions();
        updateRunModeOptions();
        updateRunModeVisibility();
      } catch (e) {
        console.error("获取资源失败", e);
      }
    }

    document.getElementById("btn-refresh").addEventListener("click", refreshAll);

    // Analysis interactions
    document.getElementById("btn-analyze").addEventListener("click", async () => {
      lastEvalPlan = null;
      lastEvalMode = null;
      lastEvalTarget = null;
      if (btnAnalyzeLock) btnAnalyzeLock.disabled = true;
      if (evalProgress) evalProgress.classList.remove("hidden");
      try {
      const algo = algoSelect.value;
      const warmup = Math.max(0, Number(warmupInput.value || 0));
      const isMonitor = algo === "monitor";
      const allowWarmup = !isMonitor && warmup > 0 && !(serverSelectMulti?.checked && (serverSelectMultiMode?.value || "distributed").toLowerCase() === "compare");
      const multiMode = !!serverSelectMulti?.checked;
      const multiPurpose = (serverSelectMultiMode?.value || "distributed").toLowerCase();
      const multiTargets = Array.from(serverSelectMultiList?.querySelectorAll(".server-multi-check") || [])
        .filter((el) => el.checked)
        .map((el) => el.value);
      const useMulti = multiMode && multiTargets.length > 0;
      const targets = useMulti ? multiTargets : [serverSelect.value];
      if (multiMode && !useMulti) {
        log("未选择多服务器，已回退单服务器评估。");
      }

      let panelPinned = false;
      function renderComparison(compare) {
        if (!compare || !Array.isArray(compare.candidates)) return;
        panelPinned = true;
        const best = compare.best || {};
        const items = compare.candidates
          .map((c) => c?.plan)
          .filter((p) => p && typeof p.estimated_time_ms === "number");
        if (!items.length) return;

        const maxMs = Math.max(...items.map((p) => p.estimated_time_ms || 0), 1);
        const rows = compare.candidates
          .map((c) => {
            const p = c.plan || {};
            const ms = typeof p.estimated_time_ms === "number" ? p.estimated_time_ms : null;
            if (ms == null) return null;
            let label = c.tag || p.backend || "plan";
            if (p.backend === "cpu") label = "CPU";
            if (p.backend === "cuda") label = `GPU(${(p.devices || [])[0] ?? "-"})`;
            if (p.backend === "multi-gpu") label = `Multi-GPU(${(p.devices || []).length})`;
            const pct = Math.max(2, Math.round((ms / maxMs) * 100));
            const isBest = (p.backend === best.backend) && JSON.stringify(p.devices || []) === JSON.stringify(best.devices || []);
            const speedup = ms > 0 && best.estimated_time_ms ? (ms / best.estimated_time_ms) : null;
            return { label, ms, pct, isBest, speedup };
          })
          .filter(Boolean);

        const bestMs = typeof best.estimated_time_ms === "number" ? best.estimated_time_ms : null;
        const bestLabel = best.backend === "cpu"
          ? "CPU"
          : best.backend === "cuda"
            ? `GPU(${(best.devices || [])[0] ?? "-"})`
            : best.backend === "multi-gpu"
              ? `Multi-GPU(${(best.devices || []).length})`
              : (best.backend || "best");

        const barsHtml = rows
          .map((r) => {
            const color = r.isBest ? "#2563eb" : "#94a3b8";
            const border = r.isBest ? "1px solid #bfdbfe" : "1px solid #e2e8f0";
            const bg = r.isBest ? "#eff6ff" : "#f8fafc";
            const hint = r.isBest ? "最优" : (bestMs ? `慢 ${(r.ms / bestMs).toFixed(2)}×` : "");
            return `
              <div style="display:grid;gap:6px;padding:10px;border-radius:10px;background:${bg};border:${border};">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <div style="font-weight:900;">${r.label}</div>
                  <div style="font-size:12px;color:var(--muted);white-space:nowrap;">${r.ms.toFixed(2)} ms ${hint ? `· ${hint}` : ""}</div>
                </div>
                <div style="height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden;">
                  <div style="width:${r.pct}%;height:100%;background:${color};"></div>
                </div>
              </div>
            `;
          })
          .join("");

        // Real warmup curves (ms) if provided
        const warm = compare.warmup || {};
        const series = Array.isArray(warm.series) ? warm.series : [];
        const w = 520, h = 140, pad = 18;
        function polylineFor(ms) {
          if (!ms || ms.length < 2) return "";
          const minV = Math.min(...ms);
          const maxV = Math.max(...ms);
          return ms
            .map((y, i) => {
              const x = pad + (i / (ms.length - 1)) * (w - pad * 2);
              const yy = pad + (1 - (y - minV) / Math.max(1e-9, (maxV - minV))) * (h - pad * 2);
              return `${x.toFixed(1)},${yy.toFixed(1)}`;
            })
            .join(" ");
        }

        const cpuSeries = series.find((s) => (s.label || "").toUpperCase() === "CPU");
        const gpuSeries = series.find((s) => (s.label || "").toUpperCase().startsWith("GPU"));
        const mgpuSeries = series.find((s) => (s.label || "").toUpperCase().startsWith("MULTI-GPU"));
        const cpuPts = cpuSeries ? polylineFor(cpuSeries.ms) : "";
        const gpuPts = gpuSeries ? polylineFor(gpuSeries.ms) : "";
        const mgpuPts = mgpuSeries ? polylineFor(mgpuSeries.ms) : "";
        const curveLegend = cpuSeries || gpuSeries
          ? `
            <div style="display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted);">
              ${cpuSeries ? `<span><span style="display:inline-block;width:10px;height:10px;background:#2563eb;border-radius:3px;margin-right:6px;"></span>CPU</span>` : ""}
              ${gpuSeries ? `<span><span style="display:inline-block;width:10px;height:10px;background:#16a34a;border-radius:3px;margin-right:6px;"></span>${gpuSeries.label}</span>` : ""}
              ${mgpuSeries ? `<span><span style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:3px;margin-right:6px;"></span>${mgpuSeries.label}</span>` : ""}
            </div>
          `
          : `<div style="font-size:12px;color:var(--muted);">未启用 StrategyCompare warmup；若已设置 Warmup，请参考下方真实算法结果。</div>`;

        gaPanel.innerHTML = `
          <div style="width:100%;display:grid;gap:12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div style="font-weight:900;">为什么选择该方案</div>
              <div style="font-size:12px;color:var(--muted);">最优：${bestLabel}${bestMs != null ? ` · ${bestMs.toFixed(2)} ms` : ""}</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr;gap:10px;">
              ${barsHtml}
            </div>
            <div style="display:grid;gap:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="font-weight:900;">Warmup 实测耗时曲线（CPU vs GPU）</div>
                ${curveLegend}
              </div>
              <div style="border:1px dashed var(--card-border);border-radius:10px;background:var(--soft-bg);padding:10px;overflow:hidden;">
                <svg viewBox="0 0 ${w} ${h}" width="100%" height="140" preserveAspectRatio="none">
                  ${cpuPts ? `<polyline fill="none" stroke="#2563eb" stroke-width="3" points="${cpuPts}" />` : ""}
                  ${gpuPts ? `<polyline fill="none" stroke="#16a34a" stroke-width="3" points="${gpuPts}" />` : ""}
                  ${mgpuPts ? `<polyline fill="none" stroke="#f59e0b" stroke-width="3" points="${mgpuPts}" />` : ""}
                  <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
                  <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
                </svg>
              </div>
            </div>
          </div>
        `;
      }

      function planToMode(plan) {
        if (!plan) return { mode: "AUTO", devices: null };
        const backend = plan.backend || (plan.plan || {}).backend;
        const devices = plan.devices || (plan.plan || {}).devices || [];
        if (!backend) return { mode: "AUTO", devices };
        if (backend === "cpu") return { mode: "CPU", devices: [] };
        if (backend === "cuda") return { mode: "S", devices };
        if (backend === "multi-gpu") return { mode: "M", devices };
        return { mode: "AUTO", devices };
      }

      function renderWarmupSummary(title, data) {
        if (!data) return;
        const state = data.state || "unknown";
        const summary = data.summary || {};
        const perIter = Array.isArray(data.per_iter_ms) ? data.per_iter_ms : [];
        const comm = data.comm || {};
        const iterMs = summary.iter_avg_ms;
        const iterSec = summary.iter_seconds;
        const throughput = summary.throughput_ips;
        const mode = summary.mode || "-";
        const devs = Array.isArray(summary.devices) ? summary.devices.join(",") : (summary.devices ?? "-");
        const remote = Array.isArray(summary.remote_servers) ? summary.remote_servers.join(", ") : "";

        const w = 520, h = 120, pad = 14;
        let spark = "";
        if (perIter.length >= 2) {
          const minV = Math.min(...perIter);
          const maxV = Math.max(...perIter);
          const points = perIter
            .map((y, i) => {
              const x = pad + (i / (perIter.length - 1)) * (w - pad * 2);
              const yy = pad + (1 - (y - minV) / Math.max(1e-9, (maxV - minV))) * (h - pad * 2);
              return `${x.toFixed(1)},${yy.toFixed(1)}`;
            })
            .join(" ");
          spark = `
            <div style="border:1px dashed var(--card-border);border-radius:10px;background:var(--soft-bg);padding:8px;">
              <svg viewBox="0 0 ${w} ${h}" width="100%" height="120" preserveAspectRatio="none">
                <polyline fill="none" stroke="#2563eb" stroke-width="3" points="${points}" />
                <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
                <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
              </svg>
            </div>
          `;
        }

        const commAvg = comm.avg_ms ? `${Number(comm.avg_ms).toFixed(2)} ms` : "-";
        const stateText = state === "completed" ? "完成" : state;

        gaPanel.insertAdjacentHTML(
          "beforeend",
          `
            <div style="display:grid;gap:10px;padding:12px;border-radius:12px;border:1px solid var(--card-border);background:#fff;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="font-weight:900;">Warmup 实测（${title}）</div>
                <div style="font-size:12px;color:var(--muted);">状态：${stateText}</div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;">
                <div style="font-size:12px;color:var(--muted);">模式：<span style="color:var(--ink);font-weight:700;">${mode}</span></div>
                <div style="font-size:12px;color:var(--muted);">设备：<span style="color:var(--ink);font-weight:700;">${devs}</span></div>
                <div style="font-size:12px;color:var(--muted);">迭代均时：<span style="color:var(--ink);font-weight:700;">${iterMs ? Number(iterMs).toFixed(2) + " ms" : "-"}</span></div>
                <div style="font-size:12px;color:var(--muted);">吞吐：<span style="color:var(--ink);font-weight:700;">${throughput ? Number(throughput).toFixed(2) + " ind/s" : "-"}</span></div>
                <div style="font-size:12px;color:var(--muted);">迭代总时：<span style="color:var(--ink);font-weight:700;">${iterSec ? Number(iterSec).toFixed(3) + " s" : "-"}</span></div>
                <div style="font-size:12px;color:var(--muted);">通信均时：<span style="color:var(--ink);font-weight:700;">${commAvg}</span></div>
              </div>
              ${remote ? `<div style="font-size:12px;color:var(--muted);">分布式节点：${remote}</div>` : ""}
              ${spark}
            </div>
          `
        );
      }

      async function runWarmupOnServer({ sid, plan, label, remoteServers }) {
        if (isMonitor || warmup <= 0) return null;
        const ds = evalDataset?.value || "";
        if (!ds) {
          log("未选择数据集，跳过 Warmup。");
          return null;
        }
        const base = planToMode(plan);
        const mode = remoteServers && remoteServers.length ? "MNM" : base.mode;
        const devices = base.devices;
        log(`Warmup 开始：${label} · algo=${algo} dataset=${ds} mode=${mode} iters=${warmup}`);
        try {
          const resp = await fetch("/api/ga_warmup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              server_id: sid,
              algorithm: algo,
              dataset: ds,
              iterations: warmup,
              mode,
              devices,
              remote_servers: remoteServers,
              timeout_s: Math.max(60, warmup * 10),
            }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            log(`Warmup 失败：HTTP ${resp.status} ${JSON.stringify(data)}`);
            return null;
          }
          const summary = data.summary || {};
          const commAvg = data.comm?.avg_ms != null ? Number(data.comm.avg_ms).toFixed(2) + " ms" : "-";
          if (summary.iter_avg_ms != null || summary.throughput_ips != null) {
            const iterAvg = summary.iter_avg_ms != null ? Number(summary.iter_avg_ms).toFixed(2) + " ms" : "-";
            const throughput = summary.throughput_ips != null ? Number(summary.throughput_ips).toFixed(2) + " ind/s" : "-";
            log(`Warmup 结果：iter_avg=${iterAvg} throughput=${throughput} comm_avg=${commAvg}`);
          }
          renderWarmupSummary(label, data);
          return data;
        } catch (e) {
          log(`Warmup 调用异常：${e}`);
          return null;
        }
      }

      async function analyzeOne(sid) {
        const src = sources.find((s) => s.id === sid) || sources[0];
        if (isMonitor) {
          if (!(useMulti && multiPurpose === "distributed")) {
            log(`开始静态资源分析：${src.label}`);
          }
        } else {
          log(`开始算法分析：${src.label} · ${algo}`);
          gaPanel.innerHTML = `<div>算法分析中...</div>`;
        }

        // Ask backend for adaptive plan (StrategyPlan)
        let plan = null;
        try {
          const resp = await fetch("/api/strategy_plan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ server_id: sid, algorithm: algo, warmup: 0, objective: "time", multi_gpu: true, timeout_s: 60 }),
          });
          if (resp.ok) {
            plan = await resp.json();
          } else {
            let errBody = null;
            try {
              errBody = await resp.json();
            } catch (e) {
              errBody = { raw: await resp.text() };
            }
            log(`StrategyPlan 调用失败：HTTP ${resp.status} ${JSON.stringify(errBody)}`);
          }
        } catch (e) {
          plan = null;
          log(`StrategyPlan 调用异常：${e}`);
        }

        if (plan) {
          log(`StrategyPlan 结果：backend=${plan.backend} devices=${(plan.devices || []).join(",") || "-"} world_size=${plan.world_size || 1}`);
          if (plan.estimated_time_ms != null) log(`估计耗时：${plan.estimated_time_ms.toFixed(3)} ms`);
          if (plan.reason) log(`原因：${plan.reason}`);
          try { setSavedPlan(sid, plan); } catch (e) {}
        } else {
          log(`StrategyPlan 未获取到结果，使用默认策略。`);
        }

        if (isMonitor) {
          const snap = await fetchFrom(src);
          const cpu = snap.cpu || {};
          const mem = snap.memory || {};
          const gpus = snap.gpus || [];
          log(`Host: ${snap.hostname || src.label}`);
          log(`CPU: ${pct(cpu.usage_percent)} (load=${fmt(cpu.load_avg?.[0], "", "N/A")})`);
          log(`MEM: ${pct(mem.percent)} (${fmt(mem.used_mb)} / ${fmt(mem.total_mb)} MB)`);
          log(`GPU: ${gpus.length} 张`);
          gaPanel.textContent = "等待数据...";
          return { sid, plan, compare: null };
        }

        if (useMulti && multiPurpose === "distributed") {
          return { sid, plan, compare: null };
        }

        // Fetch candidate comparison and render explanation chart
        try {
          const resp = await fetch("/api/strategy_compare", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ server_id: sid, objective: "time", multi_gpu: true, warmup_iters: 0, timeout_s: 60 }),
          });
          if (resp.ok) {
            const compare = await resp.json();
            renderComparison(compare);
            return { sid, plan, compare };
          } else {
            let errBody = null;
            try { errBody = await resp.json(); } catch (e) { errBody = { raw: await resp.text() }; }
            log(`StrategyCompare 失败：HTTP ${resp.status} ${JSON.stringify(errBody)}`);
          }
        } catch (e) {
          log(`StrategyCompare 异常：${e}`);
        }
        if (allowWarmup) {
          await runWarmupOnServer({ sid, plan, label: src.label || sid, remoteServers: [] });
        }
        return { sid, plan, compare: null };
      }

      const results = [];
      if (useMulti && multiPurpose === "distributed") {
        const labels = targets.map((sid) => (sources.find((s) => s.id === sid) || {}).label || sid);
        log(`开始静态资源分析：${labels.join(" + ")}`);
        log("说明：静态计划为各服务器 StrategyPlan 合并；若开启 Warmup，将使用真实分布式 RPC 进行算法评估。");
      }
      for (const sid of targets) {
        const item = await analyzeOne(sid);
        results.push(item);
      }

      if (results.length <= 1) {
        if (results.length === 1 && results[0].plan) {
          lastEvalPlan = results[0].plan;
          lastEvalMode = "single";
          lastEvalTarget = results[0].sid;
          if (btnAnalyzeLock) btnAnalyzeLock.disabled = false;
        }
        return;
      }

      if (useMulti && multiPurpose === "distributed") {
        try {
          const resp = await fetch("/api/distributed_strategy_plan", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ servers: targets }),
          });
          const data = await resp.json();
          if (!resp.ok) {
            log(`DistributedStrategyPlan 失败：${JSON.stringify(data)}`);
            return;
          }
          lastEvalPlan = data;
          lastEvalMode = "distributed";
          lastEvalTarget = null;
          if (btnAnalyzeLock) btnAnalyzeLock.disabled = false;

          const cards = targets
            .map((sid) => {
              const src = sources.find((s) => s.id === sid) || {};
              const snap = (data.server_resources || {})[sid] || {};
              const cpu = snap.cpu || {};
              const mem = snap.memory || {};
              const gpus = Array.isArray(snap.gpus) ? snap.gpus : [];
              return `
                <div style="display:grid;gap:6px;padding:10px;border-radius:10px;background:#f8fafc;border:1px solid #e2e8f0;">
                  <div style="font-weight:900;">${src.label || sid}</div>
                  <div style="font-size:12px;color:var(--muted);">CPU ${pct(cpu.usage_percent)} · MEM ${pct(mem.percent)} · GPU ${gpus.length} 张</div>
                </div>
              `;
            })
            .join("");

          const selection = targets
            .map((sid) => {
              const src = sources.find((s) => s.id === sid) || {};
              const info = (data.servers || {})[sid] || {};
              if (info.backend === "cpu") return `${src.label || sid}: CPU`;
              const devs = Array.isArray(info.devices) && info.devices.length ? info.devices.join(",") : "-";
              return `${src.label || sid}: GPU ${devs}`;
            })
            .join(" · ");

          gaPanel.innerHTML = `
            <div style="display:grid;gap:10px;">
              <div style="font-weight:900;">分布式资源汇总（多机多卡）</div>
              ${cards}
              <div style="font-size:12px;color:var(--muted);">最佳多GPU选择：${selection}</div>
            </div>
          `;
          if (allowWarmup && targets.length) {
            const primary = targets[0];
            const label = (sources.find((s) => s.id === primary) || {}).label || primary;
            const plan = (data.servers || {})[primary] || null;
            const remote = targets.filter((t) => t !== primary);
            await runWarmupOnServer({ sid: primary, plan, label, remoteServers: remote });
          }
        } catch (e) {
          log(`DistributedStrategyPlan 异常：${e}`);
        }
        return;
      }

      const bestRows = results
        .map(({ sid, plan }) => {
          if (!plan || plan.estimated_time_ms == null) return null;
          const label = plan.backend === "cpu"
            ? "CPU"
            : plan.backend === "cuda"
              ? `GPU(${(plan.devices || [])[0] ?? "-"})`
              : plan.backend === "multi-gpu"
                ? `Multi-GPU(${(plan.devices || []).length})`
                : (plan.backend || "best");
          return { sid, label, ms: plan.estimated_time_ms };
        })
        .filter(Boolean);

      if (!bestRows.length) return;

      const maxMs = Math.max(...bestRows.map((r) => r.ms || 0), 1);
      const cards = bestRows
        .map((r) => {
          const src = sources.find((s) => s.id === r.sid) || {};
          const pct = Math.max(2, Math.round((r.ms / maxMs) * 100));
          return `
            <div style="display:grid;gap:6px;padding:10px;border-radius:10px;background:#f8fafc;border:1px solid #e2e8f0;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="font-weight:900;">${src.label || r.sid}</div>
                <div style="font-size:12px;color:var(--muted);white-space:nowrap;">${r.label} · ${r.ms.toFixed(2)} ms</div>
              </div>
              <div style="height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden;">
                <div style="width:${pct}%;height:100%;background:#2563eb;"></div>
              </div>
            </div>
          `;
        })
        .join("");

      gaPanel.innerHTML = `
        <div style="display:grid;gap:10px;">
          <div style="font-weight:900;">多机最佳方案对比</div>
          ${cards}
        </div>
      `;
      } finally {
        if (evalProgress) evalProgress.classList.add("hidden");
      }
    });

    // ---------- Module 3: run & monitor ----------
    const HISTORY_KEY = "gapa_history_v1";
    let historyCache = [];
    let historySelected = new Set();

    async function historyImport(items) {
      if (!Array.isArray(items) || !items.length) return false;
      try {
        const resp = await fetch("/api/history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items }),
        });
        if (!resp.ok) return false;
        const data = await resp.json();
        historyCache = Array.isArray(data.items) ? data.items : historyCache;
        return true;
      } catch (e) {
        return false;
      }
    }

    async function historyLoad() {
      try {
        const resp = await fetch("/api/history", { cache: "no-store" });
        if (!resp.ok) return [];
        const items = await resp.json();
        historyCache = Array.isArray(items) ? items : [];
        if (!historyCache.length) {
          try {
            const legacy = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]") || [];
            if (legacy.length) {
              const ok = await historyImport(legacy);
              if (ok) {
                localStorage.removeItem(HISTORY_KEY);
                return historyCache;
              }
            }
          } catch (e) {}
        }
        return historyCache;
      } catch (e) {
        return [];
      }
    }
    async function historyAdd(item) {
      try {
        const resp = await fetch("/api/history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(item),
        });
        if (!resp.ok) return false;
        const data = await resp.json();
        historyCache = Array.isArray(data.items) ? data.items : historyCache;
        return true;
      } catch (e) {
        return false;
      }
    }
    async function historyDelete(ids) {
      if (!Array.isArray(ids) || !ids.length) return false;
      try {
        const resp = await fetch("/api/history", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids }),
        });
        if (!resp.ok) return false;
        const data = await resp.json();
        historyCache = Array.isArray(data.items) ? data.items : historyCache;
        return true;
      } catch (e) {
        return false;
      }
    }
    async function historyClear() {
      try {
        const resp = await fetch("/api/history", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ all: true }),
        });
        if (!resp.ok) return false;
        historyCache = [];
        return true;
      } catch (e) {
        return false;
      }
    }

    function updateHistoryActions() {
      const hasSelection = historySelected.size > 0;
      if (btnHistoryDelete) btnHistoryDelete.disabled = !hasSelection;
      if (historySelectAll) {
        historySelectAll.checked = historyCache.length > 0 && historySelected.size === historyCache.length;
        historySelectAll.indeterminate = historySelected.size > 0 && historySelected.size < historyCache.length;
      }
    }

    function historyRender() {
      const items = historyCache;
      if (!items.length) {
        historyList.innerHTML = `<div style="color:var(--muted);font-size:13px;">暂无历史记录。</div>`;
        historySelected = new Set();
        updateHistoryActions();
        return;
      }
      historyList.innerHTML = items
        .map((it, idx) => {
          const commMs = it.comm_avg_ms != null ? `${Number(it.comm_avg_ms).toFixed(2)}ms` : "-";
          const checked = historySelected.has(it.id) ? "checked" : "";
          return `
            <div class="history-item" data-idx="${idx}" data-id="${it.id || ""}">
              <div class="history-item-row">
                <input type="checkbox" class="history-item-check" data-id="${it.id || ""}" ${checked} />
                <div>
                  <div style="font-weight:900;">${it.algorithm} · ${it.server_label || it.server_id}</div>
                  <div class="history-meta">${it.timestamp} · state=${it.state} · best=${it.best_score ?? "-"} · comm=${commMs}</div>
                </div>
              </div>
            </div>
          `;
        })
        .join("");
      historyList.querySelectorAll(".history-item-check").forEach((el) => {
        el.addEventListener("click", (evt) => {
          evt.stopPropagation();
          const id = el.dataset.id;
          if (!id) return;
          if (el.checked) historySelected.add(id);
          else historySelected.delete(id);
          updateHistoryActions();
        });
      });
      historyList.querySelectorAll(".history-item").forEach((el) => {
        el.addEventListener("click", (evt) => {
          if (evt.target && evt.target.classList.contains("history-item-check")) return;
          historyList.querySelectorAll(".history-item").forEach((x) => x.classList.remove("history-item--active"));
          el.classList.add("history-item--active");
          const idx = Number(el.dataset.idx);
          const it = historyCache[idx];
          if (!it) return;
          const comm = it.result?.comm || {};
          const perRank = comm.per_rank_avg_ms || {};
          const perOps = comm.per_rank_ops || {};
          const perMeta = comm.per_rank_meta || {};
          const commLines = Object.keys(perRank)
            .filter((k) => k !== "0")
            .map((k) => {
              const avg = Number(perRank[k]).toFixed(2);
              const meta = perMeta[k] || {};
              const gpuNameRaw = meta.gpu_name_short || meta.gpu_name || "";
              const gpuName = gpuNameRaw ? ` ${gpuNameRaw}` : "";
              const label = meta.host ? `${meta.host}:gpu${meta.gpu ?? k}${gpuName}` : `rank${k}${gpuName}`;
              const ops = perOps[k] || {};
              const topOps = Object.keys(ops)
                .sort((a, b) => (ops[b] || 0) - (ops[a] || 0))
                .slice(0, 3)
                .map((op) => `${op} ${Number(ops[op]).toFixed(1)}ms`);
              const opText = topOps.length ? ` (${topOps.join(", ")})` : "";
              return `comm_rank: ${label} ${avg}ms${opText}`;
            });
          historyDetail.textContent = [
            `# ${it.algorithm} @ ${it.server_label || it.server_id}`,
            `time: ${it.timestamp}`,
            `state: ${it.state}`,
            `task_id: ${it.task_id}`,
            it.dataset ? `dataset: ${it.dataset}` : "",
            it.hyperparams ? `hyperparams: ${JSON.stringify(it.hyperparams)}` : "",
            it.best_score != null ? `best_score: ${it.best_score}` : "",
            it.comm_avg_ms != null ? `comm_avg_ms: ${Number(it.comm_avg_ms).toFixed(2)}` : "",
            ...commLines,
            "",
            ...(it.logs || []),
          ]
            .filter(Boolean)
            .join("\n");
        });
      });
      updateHistoryActions();
    }
    btnHistoryClear?.addEventListener("click", async () => {
      const ok = await historyClear();
      if (ok) {
        historyRender();
        historyDetail.textContent = "历史已清空。";
      }
    });
    btnHistoryDelete?.addEventListener("click", async () => {
      const ids = Array.from(historySelected);
      if (!ids.length) return;
      const ok = await historyDelete(ids);
      if (ok) {
        historySelected = new Set();
        historyRender();
        historyDetail.textContent = "已删除选中历史。";
      }
    });
    historySelectAll?.addEventListener("change", () => {
      if (!historyCache.length) return;
      historySelected = new Set();
      if (historySelectAll.checked) {
        historyCache.forEach((it) => it.id && historySelected.add(it.id));
      }
      historyRender();
    });

    function appendRunLog(lines) {
      if (!lines || !lines.length) return;
      if (runLog.textContent.trim() === "等待任务…") runLog.textContent = "";
      runLog.textContent += lines.join("\n") + "\n";
      runLog.scrollTop = runLog.scrollHeight;
    }
    btnRunClear?.addEventListener("click", () => {
      runLog.textContent = "";
      lastLogCount = 0;
    });

    function renderRunCharts(result) {
      if (!result) return;
      const curves = result.curves && typeof result.curves === "object" ? result.curves : null;
      const objectives = result.objectives && typeof result.objectives === "object" ? result.objectives : null;
      const primaryName = objectives?.primary || null;
      const secondaryName = objectives?.secondary || null;
      const primaryArr = primaryName && curves && Array.isArray(curves[primaryName]) ? curves[primaryName] : null;
      const secondaryArr = secondaryName && curves && Array.isArray(curves[secondaryName]) ? curves[secondaryName] : null;
      const conv = primaryArr || (Array.isArray(result.convergence) ? result.convergence : []);
      const metrics = Array.isArray(result.metrics) ? result.metrics : [];
      if (!conv.length && !metrics.length) return;

      // convergence polyline
      const w = 520, h = 140, pad = 18;
      function polylineFor(arr) {
        if (!arr || arr.length < 2) return "";
        const minV = Math.min(...arr);
        const maxV = Math.max(...arr);
        return arr
          .map((y, i) => {
            const x = pad + (i / (arr.length - 1)) * (w - pad * 2);
            const yy = pad + (1 - (y - minV) / Math.max(1e-9, maxV - minV)) * (h - pad * 2);
            return `${x.toFixed(1)},${yy.toFixed(1)}`;
          })
          .join(" ");
      }

      const cpuArr = metrics.map((m) => m.cpu_usage_percent).filter((x) => x != null);
      const memArr = metrics.map((m) => m.memory_percent).filter((x) => x != null);
      const cpuPts = polylineFor(cpuArr);
      const memPts = polylineFor(memArr);
      const convPts = polylineFor(conv);
      const conv2Pts = secondaryArr ? polylineFor(secondaryArr) : "";

      const title = primaryName
        ? `指标曲线：${primaryName}${secondaryName ? " / " + secondaryName : ""}`
        : "指标曲线";
      runChart.innerHTML = `
        <div style="width:100%;display:grid;gap:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="font-weight:900;">${title}</div>
            <div style="font-size:12px;color:var(--muted);">
              <span style="display:inline-block;width:10px;height:10px;background:#2563eb;border-radius:3px;margin-right:6px;"></span>${primaryName || "primary"}
              ${secondaryName ? `<span style="display:inline-block;width:10px;height:10px;background:#a855f7;border-radius:3px;margin:0 6px 0 12px;"></span>${secondaryName}` : ""}
            </div>
          </div>
          <div style="border:1px dashed var(--card-border);border-radius:10px;background:var(--soft-bg);padding:10px;overflow:hidden;">
            <svg viewBox="0 0 ${w} ${h}" width="100%" height="140" preserveAspectRatio="none">
              ${convPts ? `<polyline fill="none" stroke="#2563eb" stroke-width="3" points="${convPts}" />` : ""}
              ${conv2Pts ? `<polyline fill="none" stroke="#a855f7" stroke-width="3" points="${conv2Pts}" />` : ""}
              <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
              <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
            </svg>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="font-weight:900;">轮次资源监视（每轮采样）</div>
            <div style="font-size:12px;color:var(--muted);">
              <span style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:3px;margin-right:6px;"></span>CPU%
              <span style="display:inline-block;width:10px;height:10px;background:#16a34a;border-radius:3px;margin:0 6px 0 12px;"></span>MEM%
            </div>
          </div>
          <div style="border:1px dashed var(--card-border);border-radius:10px;background:var(--soft-bg);padding:10px;overflow:hidden;">
            <svg viewBox="0 0 ${w} ${h}" width="100%" height="140" preserveAspectRatio="none">
              ${cpuPts ? `<polyline fill="none" stroke="#f59e0b" stroke-width="3" points="${cpuPts}" />` : ""}
              ${memPts ? `<polyline fill="none" stroke="#16a34a" stroke-width="3" points="${memPts}" />` : ""}
              <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
              <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
            </svg>
          </div>
        </div>
      `;
    }

    async function startRun() {
      const selectedServer = runServer?.value || RUN_SERVER_ID;
      const server_id = selectedServer === "all" ? "local" : selectedServer;
      const algorithm = runAlgo.value;
      const dataset = runDataset?.value || "";
      const iterations = Math.max(1, Number(runIters.value || 1));
      const crossover_rate = Math.min(1, Math.max(0, Number(runPc.value || 0.8)));
      const mutate_rate = Math.min(1, Math.max(0, Number(runPm.value || 0.2)));
      let mode = (runMode.value || "AUTO").toUpperCase();

      let devices = [];
      const snap = snapshots.get(server_id) || {};
      const hasGpu = Array.isArray(snap.gpus) && snap.gpus.length > 0;
      let remote_servers = [];

      if (mode === "AUTO" || mode === "MNM") {
        try {
          const resp = await fetch(`/api/resource_lock/status?scope=all`, { cache: "no-store" });
          const data = await resp.json();
          if (resp.ok) {
            const results = data.results || {};
            remote_servers = Object.keys(results).filter((k) => k !== "local" && results[k]?.active);
            if (selectedServer === "all") {
              mode = "MNM";
            }
          }
        } catch (e) {
          remote_servers = [];
        }
      }

      if (mode === "AUTO") {
        const saved = getSavedPlan(server_id);
        if (saved && saved.plan && Array.isArray(saved.plan.devices)) {
          devices = saved.plan.devices;
        }
      } else if (mode === "CPU") {
        devices = [];
      } else if ((mode === "S" || mode === "SM") && hasGpu) {
        devices = [Number(runGpuSingle.value)];
      } else if ((mode === "M" || mode === "MNM") && hasGpu) {
        const checked = Array.from(runGpuMulti.querySelectorAll(".run-gpu-check"))
          .filter((el) => el.checked)
          .map((el) => Number(el.value));
        devices = checked;
      }
      if (mode === "M" && (!hasGpu || !devices.length)) {
        appendRunLog([`[WARN] 未选中多卡，已切换为 S。`]);
        mode = "S";
        if (hasGpu) {
          devices = [Number(runGpuSingle.value)];
        } else {
          devices = [];
        }
      }

      if (mode !== "MNM") {
        remote_servers = [];
      }

      // reset UI
      runState.textContent = "starting";
      runTaskId.textContent = "-";
      runProgress.style.width = "0%";
      runProgressText.textContent = "0%";
      runBest.textContent = "-";
      if (runComm) runComm.textContent = "-";
      if (runCommDetail) runCommDetail.textContent = "";
      runChart.textContent = "等待数据...";
      runLog.textContent = "";
      lastLogCount = 0;

      const resp = await fetch("/api/analysis/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          server_id,
          algorithm,
          dataset,
          iterations,
          crossover_rate,
          mutate_rate,
          mode,
          devices,
          remote_servers,
          release_lock_on_finish: true,
          timeout_s: 20,
        }),
      });
      if (!resp.ok) {
        let errBody = null;
        try { errBody = await resp.json(); } catch (e) { errBody = { raw: await resp.text() }; }
        appendRunLog([`[ERROR] start failed: HTTP ${resp.status} ${JSON.stringify(errBody)}`]);
        runState.textContent = "error";
        return;
      }
      const data = await resp.json();
      runTaskId.textContent = data.task_id || "-";
      runState.textContent = data.status || "started";
      appendRunLog([`[INFO] task started: ${data.task_id}`]);

      // poll status
      if (currentPoll) clearInterval(currentPoll);
      currentPoll = setInterval(() => pollRunStatus(server_id), 1200);
      pollRunStatus(server_id);
    }

    async function stopRun() {
      const server_id = RUN_SERVER_ID;
      try {
        btnRunStop.disabled = true;
        const resp = await fetch(`/api/analysis/stop`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ server_id }),
        });
        if (!resp.ok) {
          appendRunLog([`[ERROR] stop failed: HTTP ${resp.status}`]);
        } else {
          const data = await resp.json();
          appendRunLog([`[WARN] stop requested: ${JSON.stringify(data)}`]);
        }
      } catch (e) {
        appendRunLog([`[ERROR] stop failed: ${e}`]);
      }
    }

    async function pollRunStatus(server_id) {
      const resp = await fetch(`/api/analysis/status?server_id=${encodeURIComponent(server_id)}&timeout_s=10`, { cache: "no-store" });
      if (!resp.ok) return;
      const st = await resp.json();
      runState.textContent = st.state || "unknown";
      btnRunStop.disabled = !(st.state === "running");
      const p = Number(st.progress || 0);
      runProgress.style.width = `${Math.max(0, Math.min(100, p))}%`;
      runProgressText.textContent = `${Math.max(0, Math.min(100, p))}%`;

      const logs = Array.isArray(st.logs) ? st.logs : [];
      if (logs.length > lastLogCount) {
        appendRunLog(logs.slice(lastLogCount));
        lastLogCount = logs.length;
      }

      if (st.result) {
        const best = st.result.best_score;
        if (best != null) runBest.textContent = String(best);
        if (runComm) {
          const comm = st.result.comm || {};
          const avgMs = comm.avg_ms;
          runComm.textContent = avgMs ? `${Number(avgMs).toFixed(2)} ms` : "-";
          if (runCommDetail) {
            const perRank = comm.per_rank_avg_ms || {};
            const perOps = comm.per_rank_ops || {};
            const perMeta = comm.per_rank_meta || {};
            const items = Object.keys(perRank)
              .filter((k) => k !== "0")
              .map((k) => {
                const avg = Number(perRank[k]).toFixed(2);
                const meta = perMeta[k] || {};
                const gpuNameRaw = meta.gpu_name_short || meta.gpu_name || "";
                const gpuName = gpuNameRaw ? ` ${gpuNameRaw}` : "";
                const label = meta.host ? `${meta.host}:gpu${meta.gpu ?? k}${gpuName}` : `rank${k}${gpuName}`;
                const ops = perOps[k] || {};
                const topOps = Object.keys(ops)
                  .sort((a, b) => (ops[b] || 0) - (ops[a] || 0))
                  .slice(0, 2)
                  .map((op) => `${op} ${Number(ops[op]).toFixed(1)}ms`);
                const opText = topOps.length ? ` (${topOps.join(", ")})` : "";
                return `${label} ${avg}ms${opText}`;
              });
            runCommDetail.textContent = items.length ? items.join(" / ") : "";
          }
        }
        renderRunCharts(st.result);
      }

      if (st.state === "completed" || st.state === "error" || st.state === "idle") {
        if (currentPoll) {
          clearInterval(currentPoll);
          currentPoll = null;
        }
        // persist to history
        const saved = {
          timestamp: new Date().toLocaleString(),
          server_id,
          server_label: (sources.find((s) => s.id === server_id) || {}).label,
          algorithm: runAlgo.value,
          dataset: runDataset?.value || null,
          task_id: st.task_id,
          state: st.state,
          best_score: st.result ? st.result.best_score : null,
          comm_avg_ms: st.result && st.result.comm && st.result.comm.avg_ms != null ? st.result.comm.avg_ms : null,
          hyperparams: st.result ? st.result.hyperparams : null,
          logs: logs.slice(-500),
          result: st.result || null,
        };
        const ok = await historyAdd(saved);
        if (ok) {
          historyRender();
        }
      }
    }

    btnRun?.addEventListener("click", startRun);
    btnRunStop?.addEventListener("click", stopRun);

    async function refreshRunLockStatus() {
      try {
        const resp = await fetch(`/api/resource_lock/status?scope=all`, { cache: "no-store" });
        const data = await resp.json();
        if (!resp.ok) {
          if (runLockStatus) runLockStatus.textContent = "锁定状态获取失败";
          return;
        }
        const results = data.results || {};
        updateRunServerOptions(results);
        const sel = runServer?.value || RUN_SERVER_ID;
        const activeRemote = Object.keys(results).filter((k) => k !== "local" && results[k]?.active);
        if (sel === "all") {
          if (activeRemote.length) {
            runLockStatus.textContent = "分布式锁定已启用";
            runLockDetail.textContent = `远程服务器：${activeRemote.join(", ")}`;
          } else {
            runLockStatus.textContent = "未锁定";
            runLockDetail.textContent = "未锁定时将默认使用 CPU 运行";
          }
          return;
        }
        const info = results[sel] || {};
        if (info?.active) {
          const label = (sources.find((s) => s.id === sel) || {}).label || sel;
          runLockStatus.textContent = `${label} 已锁定`;
          const devices = Array.isArray(info.devices) ? info.devices.join(",") : "-";
          const exp = info.expires_at ? new Date(info.expires_at * 1000).toLocaleString() : "-";
          runLockDetail.textContent = `backend=${info.backend} devices=${devices} expires=${exp}`;
        } else {
          runLockStatus.textContent = "未锁定";
          runLockDetail.textContent = "未锁定时将默认使用 CPU 运行";
        }
      } catch (e) {
        if (runLockStatus) runLockStatus.textContent = "锁定状态获取失败";
      }
    }

    btnRunLockRefresh?.addEventListener("click", refreshRunLockStatus);
    btnRunLockRelease?.addEventListener("click", () => releaseLock(RUN_SERVER_ID));

    async function applyEvalPlanToLock() {
      if (!lastEvalPlan || !lastEvalMode) return;
      try {
        const stResp = await fetch(`/api/resource_lock/status?scope=all`, { cache: "no-store" });
        const stData = await stResp.json();
        const results = stData.results || {};
        const hasActive = Object.values(results).some((v) => v && v.active);
        if (hasActive) {
          alert("已有资源锁定在运行，请先释放锁定。");
          return;
        }
      } catch (e) {
        // ignore status errors, continue to attempt lock
      }

      if (lastEvalMode === "distributed") {
        const devicesByServer = lastEvalPlan.devices_by_server || {};
        if (!Object.keys(devicesByServer).length) {
          alert("分布式评估未返回可锁定的设备。");
          return;
        }
        const resp = await fetch("/api/resource_lock", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ scope: "all", devices_by_server: devicesByServer, strict_idle: true }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          alert(`资源锁定失败: ${JSON.stringify(data)}`);
          return;
        }
        lockLog(`已应用分布式锁定策略: ${JSON.stringify(data.results || data)}`);
        fetchLockStatus("all");
        return;
      }

      const devices = Array.isArray(lastEvalPlan.devices) ? lastEvalPlan.devices : [];
      if (!devices.length) {
        alert("评估结果未包含可用设备，无法锁定。");
        return;
      }
      const scope = lastEvalTarget || "local";
      const resp = await fetch("/api/resource_lock", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ scope, devices }),
      });
      const data = await resp.json();
      if (!resp.ok) {
        alert(`资源锁定失败: ${JSON.stringify(data)}`);
        return;
      }
      lockLog(`已应用锁定策略: ${JSON.stringify(data.results || data)}`);
      fetchLockStatus("local");
    }

    btnAnalyzeLock?.addEventListener("click", applyEvalPlanToLock);

    async function applyLock() {
      const scope = lockScope?.value || "all";
      const mode = (lockMode?.value || "auto").toLowerCase();
      const duration_s = Math.max(10, Number(lockDuration.value || 600));
      const warmup_iters = Math.max(0, Number(lockWarmup.value || 2));
      const mem_mb = Math.max(0, Number(lockMem.value || 0));
      let devices = null;
      let devices_by_server = null;
      if (mode === "manual") {
        const checked = Array.from(lockServerList.querySelectorAll(".lock-gpu-check"))
          .filter((el) => el.checked)
          .map((el) => ({ server: el.dataset.server, id: Number(el.value) }));
        if (!checked.length) {
          alert("请选择至少一张显卡");
          return;
        }
        devices_by_server = {};
        checked.forEach((item) => {
          if (!devices_by_server[item.server]) devices_by_server[item.server] = [];
          devices_by_server[item.server].push(item.id);
        });
        if (scope !== "all" && devices_by_server[scope]) {
          devices = devices_by_server[scope];
        }
      }
      try {
        lockLog(`开始锁定资源: scope=${scope}, mode=${mode}, mem=${mem_mb}MB`);
        const resp = await fetch("/api/resource_lock", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ scope, duration_s, warmup_iters, mem_mb, devices, devices_by_server }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          lockLog(`锁定失败: ${JSON.stringify(data)}`);
          alert(`资源锁定失败: ${JSON.stringify(data)}`);
          return;
        }
        lockLog(`锁定完成: ${JSON.stringify(data.results || data)}`);
        fetchLockStatus(scope);
        closeLockModal();
      } catch (e) {
        lockLog(`锁定失败: ${e}`);
        alert(`资源锁定失败: ${e}`);
      }
    }

    async function releaseLock(scopeOverride) {
      const scope = scopeOverride || lockScope?.value || "all";
      try {
        const resp = await fetch("/api/resource_lock/release", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ scope }),
        });
        const data = await resp.json();
        if (!resp.ok) {
          lockLog(`释放失败: ${JSON.stringify(data)}`);
          alert(`释放失败: ${JSON.stringify(data)}`);
          return;
        }
        lockLog(`已释放资源锁定: ${JSON.stringify(data.results || data)}`);
        fetchLockStatus(scope);
        closeLockModal();
      } catch (e) {
        lockLog(`释放失败: ${e}`);
        alert(`释放失败: ${e}`);
      }
    }

    lockApply?.addEventListener("click", applyLock);
    lockRelease?.addEventListener("click", releaseLock);
    btnLockStatus?.addEventListener("click", () => fetchLockStatus(lockStatusScope?.value || "all"));
    btnLockReleaseNow?.addEventListener("click", () => {
      const scope = lockStatusScope?.value || "all";
      releaseLock(scope);
      fetchLockStatus(scope);
    });

    // Boot
    (async () => {
      await loadAlgorithms();
      await loadDatasets();
      await loadConfigServers();
      updateLockScopeOptions();
      updateServerMultiList();
      refreshAll();
      fetchLockStatus("all");
      await refreshRunLockStatus();
      applyRunConfig();
      await historyLoad();
      historyRender();
      updateRunDatasetOptions();
      updateEvalDatasetOptions();
      if (evalDataset) evalDataset.disabled = algoSelect?.value === "monitor";
    })();
  </script>
</body>
</html>
