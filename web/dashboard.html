<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GAPA Console · 资源监控与算法控制台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f8fafc;
      --panel: #ffffff;
      --panel-border: #dbeafe;
      --text: #0f172a;
      --muted: #64748b;
      --blue-600: #2563eb;
      --blue-700: #1d4ed8;
      --blue-50: #eff6ff;
      --rose: #e11d48;
      --card-border: #e2e8f0;
      --soft-bg: #f1f5f9;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Microsoft YaHei", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .hidden { display: none !important; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 24px; }

    .header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--panel);
      border-bottom: 1px solid var(--panel-border);
    }
    .header-inner { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; }
    .title { font-size: 22px; font-weight: 800; letter-spacing: .2px; }
    .subtitle { font-size: 13px; color: var(--muted); margin-top: 4px; }
    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      background: var(--blue-50);
      color: var(--blue-600);
      border: 1px solid var(--panel-border);
      white-space: nowrap;
    }

    .layout { display: flex; gap: 16px; padding: 16px 0 20px; }
    .sidebar {
      width: 240px;
      flex: 0 0 240px;
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      padding: 10px;
      position: sticky;
      top: 72px;
      height: calc(100vh - 92px);
      overflow: auto;
    }
    .nav-title { font-size: 12px; color: var(--muted); font-weight: 800; padding: 8px 10px; }
    .nav-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      font-size: 13px;
      font-weight: 800;
      cursor: pointer;
      text-align: left;
    }
    .nav-item:hover { background: var(--blue-50); border-color: var(--panel-border); }
    .nav-item--active { background: var(--blue-50); border-color: #93c5fd; color: var(--blue-700); }
    .nav-badge {
      font-size: 11px;
      font-weight: 900;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
      border: 1px solid #e0e7ff;
    }
    .content { flex: 1; min-width: 0; }

    .section {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
      padding: 18px;
    }
    .section-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .section-title { font-size: 16px; font-weight: 800; }

    .btn {
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid transparent;
      white-space: nowrap;
    }
    .btn-primary { background: var(--blue-600); color: #fff; box-shadow: 0 1px 2px rgba(37,99,235,.25); }
    .btn-primary:hover { background: var(--blue-700); }
    .btn-secondary { background: var(--blue-50); color: var(--blue-700); border-color: var(--panel-border); }
    .btn-secondary:hover { background: #e6f0ff; }

    .view { display: none; }
    .view--active { display: grid; gap: 20px; }

    /* Resource pool: horizontal large cards */
    .cards { margin-top: 14px; display: grid; grid-template-columns: 1fr; gap: 12px; }
    .card {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      padding: 14px;
      transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease;
      cursor: pointer;
      display: grid;
      gap: 12px;
    }
    .card:hover { box-shadow: 0 6px 18px rgba(15,23,42,.08); transform: translateY(-2px); border-color: #bfdbfe; }
    .card--expanded { border-color: #93c5fd; }
    .card-top { display: flex; gap: 14px; align-items: stretch; }
    .card-left { width: 280px; flex: 0 0 280px; display: grid; gap: 10px; }
    .card-head { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
    .card-name { font-size: 15px; font-weight: 900; line-height: 1.2; }
    .card-type { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .badge {
      font-size: 11px;
      font-weight: 800;
      color: var(--blue-700);
      background: var(--blue-50);
      border: 1px solid var(--panel-border);
      padding: 4px 8px;
      border-radius: 999px;
      flex: 0 0 auto;
    }
    .card-mid { flex: 1; min-width: 0; display: grid; align-content: start; }
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px; margin-top: 4px; }
    .stat { background: var(--soft-bg); border: 1px solid #f1f5f9; border-radius: 8px; padding: 8px; }
    .stat-label { color: var(--muted); font-size: 11px; }
    .stat-value { margin-top: 2px; font-weight: 900; }
    .stat { min-height: 52px; }
    .error { margin-top: 8px; font-size: 12px; color: var(--rose); }

    .card-bottom {
      display: none;
      border-top: 1px dashed #e2e8f0;
      padding-top: 12px;
    }
    .card--expanded .card-bottom { display: block; }

    .details {
      font-size: 12px;
      color: #334155;
      display: grid;
      gap: 6px;
    }

    .gpu-item { margin-top: 6px; background: #fff; border: 1px solid #f1f5f9; border-radius: 8px; padding: 8px; font-size: 12px; }
    .gpu-title { font-weight: 800; }

    /* Eval layout */
    .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 18px; }
    @media (min-width: 1024px) { .analysis-grid { grid-template-columns: 3fr 7fr; } }
    .panel { display: flex; flex-direction: column; min-height: 420px; }
    .form { margin-top: 12px; display: grid; gap: 10px; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    select, input, textarea {
      width: 100%;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 8px;
      border: 1px solid var(--card-border);
      background: #fff;
      color: var(--text);
      outline: none;
    }
    select:focus, input:focus, textarea:focus {
      border-color: #93c5fd;
      box-shadow: 0 0 0 3px rgba(147,197,253,.35);
    }
    .log-wrap { margin-top: 12px; flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .log-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .log-title { font-size: 12px; font-weight: 800; color: #334155; }
    .log-clear { background: none; border: none; font-size: 12px; color: var(--muted); cursor: pointer; }
    .log-clear:hover { color: var(--text); }
    .log-box {
      flex: 1;
      border: 1px solid var(--card-border);
      background: var(--soft-bg);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      line-height: 1.5;
      overflow: auto;
      white-space: pre-wrap;
      max-height: 260px;
    }
    .log-box::-webkit-scrollbar { width: 8px; height: 8px; }
    .log-box::-webkit-scrollbar-thumb { background: rgba(37,99,235,.45); border-radius: 8px; }
    .log-box::-webkit-scrollbar-track { background: transparent; }

    .ga-panel {
      margin-top: 12px;
      min-height: 420px;
      border: 1px dashed var(--card-border);
      border-radius: 8px;
      background: var(--soft-bg);
      display: block;
      color: var(--muted);
      padding: 16px;
      overflow: auto;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }
    .modal-backdrop.flex { display: flex; }
    .modal {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border: 1px solid #f1f5f9;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(15,23,42,.2);
    }
    .modal-head, .modal-foot {
      padding: 12px 14px;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .modal-foot { border-bottom: none; border-top: 1px solid #f1f5f9; justify-content: flex-end; }
    .modal-title { font-size: 14px; font-weight: 900; }
    .modal-close { background: none; border: none; font-size: 20px; color: var(--muted); cursor: pointer; line-height: 1; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 12px 14px; display: grid; gap: 10px; }
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    @media (max-width: 980px) {
      .layout { flex-direction: column; }
      .sidebar { width: auto; flex: 0 0 auto; height: auto; position: static; }
      .card-top { flex-direction: column; }
      .card-left { width: auto; flex: 0 0 auto; }
    }

    /* Algo run UI */
    .kv { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .kv-item { border: 1px solid var(--card-border); background: #fff; border-radius: 10px; padding: 10px; }
    .kv-label { font-size: 11px; color: var(--muted); font-weight: 800; }
    .kv-value { margin-top: 4px; font-size: 13px; font-weight: 900; }
    .progress { margin-top: 10px; height: 10px; border-radius: 999px; background: #e2e8f0; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; background: var(--blue-600); }
    .split { display: grid; grid-template-columns: 1fr; gap: 16px; margin-top: 12px; }
    @media (min-width: 1024px) { .split { grid-template-columns: 1fr 1fr; } }
    .history-list { display: grid; gap: 10px; margin-top: 12px; }
    .history-item { border: 1px solid var(--card-border); background: #fff; border-radius: 10px; padding: 10px; cursor: pointer; }
    .history-item:hover { border-color: #bfdbfe; box-shadow: 0 6px 18px rgba(15,23,42,.06); }
    .history-meta { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .history-actions { display: flex; gap: 8px; margin-top: 10px; }
  </style>
</head>
<body>
  <header class="header">
    <div class="container header-inner">
      <div>
        <div class="title">GAPA Console</div>
        <div class="subtitle">资源实时监控 · 服务器评估 · 算法运行与监控</div>
      </div>
      <div class="pill">Live · 2秒刷新</div>
    </div>
  </header>

  <div class="container layout">
    <aside class="sidebar">
      <div class="nav-title">导航</div>
      <button class="nav-item nav-item--active" data-view="monitor"><span>资源池监控</span><span class="nav-badge">1</span></button>
      <button class="nav-item" data-view="eval"><span>服务器测试评估</span><span class="nav-badge">2</span></button>
      <button class="nav-item" data-view="algo"><span>算法运行与监控</span><span class="nav-badge">3</span></button>
      <button class="nav-item" data-view="config"><span>配置修改</span><span class="nav-badge">4</span></button>
      <button class="nav-item" data-view="history"><span>历史记录</span><span class="nav-badge">H</span></button>
      <div class="nav-title">提示</div>
      <div style="font-size:12px;color:var(--muted);padding:0 10px 10px;">
        资源卡片点击展开详情；详情区域支持滚动。
      </div>
    </aside>

    <main class="content">
      <!-- View 1: Monitor -->
      <div class="view view--active" id="view-monitor">
        <section class="section">
          <div class="section-header">
            <div class="section-title">资源池</div>
            <div>
              <button id="btn-refresh" class="btn btn-secondary">全部刷新</button>
            </div>
          </div>
          <div class="cards" id="cards">
            <div style="text-align:center;color:var(--muted);padding:28px 0;">正在加载本地资源…</div>
          </div>
        </section>
      </div>

      <!-- View 2: Eval -->
      <div class="view" id="view-eval">
        <section class="analysis-grid">
          <div class="section panel">
            <div class="section-title">服务器分析</div>
            <div class="form">
              <div>
                <label>选择服务器</label>
                <select id="select-server">
                  <option value="local">本机</option>
                </select>
              </div>
              <div>
                <label>选择算法</label>
                <select id="select-algo">
                  <option value="monitor" data-kind="monitor">仅监控资源</option>
                </select>
              </div>
              <div id="warmup-wrap" class="hidden">
                <label>Warm up 次数</label>
                <input id="input-warmup" type="number" min="0" value="2" />
              </div>
              <button id="btn-analyze" class="btn btn-primary" style="width:100%;">开始分析</button>
            </div>

            <div class="log-wrap">
              <div class="log-head">
                <div class="log-title">分析日志</div>
                <button id="btn-clear-log" class="log-clear">清空</button>
              </div>
              <div id="log-box" class="log-box">等待操作…</div>
            </div>
          </div>

          <div class="section panel">
            <div class="section-header">
              <div class="section-title">遗传算法分析</div>
              <div style="font-size:11px;color:var(--muted);">预留 ECharts 面板</div>
            </div>
            <div id="ga-panel" class="ga-panel">等待数据...</div>
          </div>
        </section>
      </div>

      <!-- View 3: Algorithm run & monitor -->
      <div class="view" id="view-algo">
        <section class="section">
          <div class="section-header">
            <div class="section-title">算法运行与监控</div>
            <div style="font-size:12px;color:var(--muted);">提交任务 · 轮询状态 · 日志/结果可视化</div>
          </div>
          <div class="split">
            <div>
              <div class="form">
                <div>
                  <label>选择服务器</label>
                  <select id="run-server"></select>
                </div>
                <div>
                  <label>选择算法</label>
                  <select id="run-algo"></select>
                </div>
                <div>
                  <label>选择数据集</label>
                  <select id="run-dataset"></select>
                </div>
                <div>
                  <label>运行模式</label>
                  <select id="run-mode">
                    <option value="AUTO">默认（使用资源评估结果）</option>
                    <option value="CPU">CPU</option>
                    <option value="S">S（单卡）</option>
                    <option value="SM">SM（单卡加速）</option>
                    <option value="M">M（多卡）</option>
                    <option value="MNM" disabled>MNM（多机多卡 Coming Soon）</option>
                  </select>
                </div>
                <div id="run-gpu-single-wrap" class="hidden">
                  <label>选择显卡（单选）</label>
                  <select id="run-gpu-single"></select>
                </div>
                <div id="run-gpu-multi-wrap" class="hidden">
                  <label>选择显卡（多选）</label>
                  <div id="run-gpu-multi" style="display:grid;gap:8px;"></div>
                </div>
                <div>
                  <label>迭代次数</label>
                  <input id="run-iters" type="number" min="1" value="20" />
                </div>
                <div class="row-2">
                  <div>
                    <label>交叉率 (pc)</label>
                    <input id="run-pc" type="number" min="0" max="1" step="0.01" value="0.80" />
                  </div>
                  <div>
                    <label>变异率 (pm)</label>
                    <input id="run-pm" type="number" min="0" max="1" step="0.01" value="0.20" />
                  </div>
                </div>
                <button id="btn-run" class="btn btn-primary" style="width:100%;">提交运行</button>
              </div>

              <div class="kv">
                <div class="kv-item">
                  <div class="kv-label">状态</div>
                  <div id="run-state" class="kv-value">idle</div>
                </div>
                <div class="kv-item">
                  <div class="kv-label">任务ID</div>
                  <div id="run-taskid" class="kv-value">-</div>
                </div>
              </div>
              <div class="kv">
                <div class="kv-item">
                  <div class="kv-label">进度</div>
                  <div id="run-progress-text" class="kv-value">0%</div>
                  <div class="progress"><div id="run-progress" class="progress-bar"></div></div>
                </div>
                <div class="kv-item">
                  <div class="kv-label">最优值</div>
                  <div id="run-best" class="kv-value">-</div>
                </div>
              </div>
            </div>

            <div>
              <div class="log-head" style="margin-top:0;">
                <div class="log-title">实时日志</div>
                <button id="btn-run-clear" class="log-clear">清空</button>
              </div>
              <div id="run-log" class="log-box" style="max-height:260px;">等待任务…</div>
              <div style="margin-top:12px;">
                <div class="log-title">结果可视化</div>
                <div id="run-chart" class="ga-panel" style="min-height:260px;">等待数据...</div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- View 4: Config -->
      <div class="view" id="view-config">
        <section class="section">
          <div class="section-header">
            <div class="section-title">配置修改</div>
            <div>
              <button id="btn-open-modal" class="btn btn-primary">+ 添加卡片节点</button>
            </div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px;line-height:1.6;">
            这里用于维护服务器节点配置（新增/编辑/移除）。当前版本：前端临时添加卡片节点（刷新页面后不持久化）。
          </div>
        </section>
      </div>

      <!-- View 5: History -->
      <div class="view" id="view-history">
        <section class="section">
          <div class="section-header">
            <div class="section-title">历史记录</div>
            <div class="history-actions">
              <button id="btn-history-clear" class="btn btn-secondary">清空历史</button>
            </div>
          </div>
          <div id="history-list" class="history-list"></div>
          <div style="margin-top:12px;">
            <div class="log-title">记录详情</div>
            <div id="history-detail" class="log-box" style="max-height:320px;">选择一条记录查看日志与指标。</div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Add Server Modal -->
  <div id="modal" class="modal-backdrop hidden">
    <div class="modal">
      <div class="modal-head">
        <div class="modal-title">添加服务器节点</div>
        <button id="btn-close-modal" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div>
          <label>IP 地址</label>
          <input id="modal-ip" placeholder="如 192.168.1.100" />
        </div>
        <div>
          <label>端口</label>
          <input id="modal-port" type="number" value="7777" />
        </div>
        <div class="row-2">
          <div>
            <label>用户名</label>
            <input id="modal-user" placeholder="可选" />
          </div>
          <div>
            <label>密码</label>
            <input id="modal-pass" type="password" placeholder="可选" />
          </div>
        </div>
      </div>
      <div class="modal-foot">
        <button id="btn-cancel" class="btn btn-secondary">取消</button>
        <button id="btn-add" class="btn btn-primary">添加</button>
      </div>
    </div>
  </div>

  <script>
    function setActiveView(view) {
      document.querySelectorAll(".nav-item").forEach((btn) => {
        btn.classList.toggle("nav-item--active", btn.dataset.view === view);
      });
      document.querySelectorAll(".view").forEach((v) => {
        v.classList.toggle("view--active", v.id === `view-${view}`);
      });
      try { localStorage.setItem("gapa_view", view); } catch (e) {}
    }

    document.querySelectorAll(".nav-item").forEach((btn) => {
      btn.addEventListener("click", () => setActiveView(btn.dataset.view));
    });
    try {
      const saved = localStorage.getItem("gapa_view");
      if (saved) setActiveView(saved);
    } catch (e) {}

    const cardsDiv = document.getElementById("cards");
    const serverSelect = document.getElementById("select-server");
    const algoSelect = document.getElementById("select-algo");
    const warmupWrap = document.getElementById("warmup-wrap");
    const warmupInput = document.getElementById("input-warmup");
    const logBox = document.getElementById("log-box");
    const gaPanel = document.getElementById("ga-panel");

    const modal = document.getElementById("modal");
    const btnOpenModal = document.getElementById("btn-open-modal");
    const btnCloseModal = document.getElementById("btn-close-modal");
    const btnCancel = document.getElementById("btn-cancel");
    const btnAdd = document.getElementById("btn-add");

    const sources = [{ id: "local", base: "", label: "本机", expanded: true, meta: { type: "local" } }];
    const snapshots = new Map();

    // Algo run DOM
    const runServer = document.getElementById("run-server");
    const runAlgo = document.getElementById("run-algo");
    const runDataset = document.getElementById("run-dataset");
    const runMode = document.getElementById("run-mode");
    const runGpuSingleWrap = document.getElementById("run-gpu-single-wrap");
    const runGpuSingle = document.getElementById("run-gpu-single");
    const runGpuMultiWrap = document.getElementById("run-gpu-multi-wrap");
    const runGpuMulti = document.getElementById("run-gpu-multi");
    const runIters = document.getElementById("run-iters");
    const runPc = document.getElementById("run-pc");
    const runPm = document.getElementById("run-pm");
    const btnRun = document.getElementById("btn-run");
    const runState = document.getElementById("run-state");
    const runTaskId = document.getElementById("run-taskid");
    const runProgress = document.getElementById("run-progress");
    const runProgressText = document.getElementById("run-progress-text");
    const runBest = document.getElementById("run-best");
    const runLog = document.getElementById("run-log");
    const runChart = document.getElementById("run-chart");
    const btnRunClear = document.getElementById("btn-run-clear");

    // History DOM
    const historyList = document.getElementById("history-list");
    const historyDetail = document.getElementById("history-detail");
    const btnHistoryClear = document.getElementById("btn-history-clear");

    const HISTORY_KEY = "gapa_history_v1";
    const PLAN_KEY = "gapa_saved_plans_v1";
    let datasetsManifest = null;
    let currentPoll = null;
    let lastLogCount = 0;

    function fmt(val, unit = "", fallback = "N/A") {
      return val == null ? fallback : `${val}${unit}`;
    }
    function pct(val) {
      return val == null ? "N/A" : `${Number(val).toFixed(1)}%`;
    }
    function log(line) {
      const ts = new Date().toLocaleTimeString();
      const next = `[${ts}] ${line}\n`;
      if (logBox.textContent.trim() === "等待操作…") logBox.textContent = "";
      logBox.textContent += next;
      logBox.scrollTop = logBox.scrollHeight;
    }

    function openModal() {
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      document.getElementById("modal-ip").focus();
    }
    function closeModal() {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
      document.getElementById("modal-ip").value = "";
      document.getElementById("modal-port").value = "7777";
      document.getElementById("modal-user").value = "";
      document.getElementById("modal-pass").value = "";
    }

    btnOpenModal.addEventListener("click", openModal);
    btnCloseModal.addEventListener("click", closeModal);
    btnCancel.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => {
      if (e.target === modal) closeModal();
    });

    document.getElementById("btn-clear-log").addEventListener("click", () => {
      logBox.textContent = "";
    });

    function updateServerSelect() {
      const current = serverSelect.value;
      serverSelect.innerHTML = sources.map((s) => `<option value="${s.id}">${s.label}</option>`).join("");
      serverSelect.value = sources.some((s) => s.id === current) ? current : "local";
      if (runServer) {
        const cur2 = runServer.value;
        runServer.innerHTML = sources.map((s) => `<option value="${s.id}">${s.label}</option>`).join("");
        runServer.value = sources.some((s) => s.id === cur2) ? cur2 : "local";
        updateRunGpuOptions();
      }
    }

    function plansLoad() {
      try { return JSON.parse(localStorage.getItem(PLAN_KEY) || "{}") || {}; } catch (e) { return {}; }
    }
    function plansSave(obj) {
      try { localStorage.setItem(PLAN_KEY, JSON.stringify(obj)); } catch (e) {}
    }
    function getSavedPlan(server_id) {
      const all = plansLoad();
      return all[server_id] || null;
    }
    function setSavedPlan(server_id, plan) {
      const all = plansLoad();
      all[server_id] = { plan, saved_at: new Date().toLocaleString() };
      plansSave(all);
    }

    function updateRunGpuOptions() {
      if (!runServer) return;
      const sid = runServer.value;
      const snap = snapshots.get(sid) || {};
      const gpus = Array.isArray(snap.gpus) ? snap.gpus : [];
      const options = gpus.map((g) => ({ id: g.id, name: g.name || `GPU ${g.id}` }));

      if (runGpuSingle) {
        runGpuSingle.innerHTML = options.map((o) => `<option value="${o.id}">${o.name} (#${o.id})</option>`).join("");
      }
      if (runGpuMulti) {
        runGpuMulti.innerHTML = options
          .map((o) => {
            return `
              <label style="display:flex;gap:10px;align-items:center;border:1px solid var(--card-border);border-radius:10px;padding:8px;background:#fff;">
                <input type="checkbox" class="run-gpu-check" value="${o.id}" />
                <span style="font-weight:900;">${o.name}</span>
                <span style="color:var(--muted);font-size:12px;">#${o.id}</span>
              </label>
            `;
          })
          .join("");
      }

      // Apply default selection from saved plan for AUTO
      const saved = getSavedPlan(sid);
      if (saved && saved.plan && Array.isArray(saved.plan.devices) && saved.plan.devices.length) {
        const devs = saved.plan.devices.map((x) => Number(x));
        if (runGpuSingle && devs.length) runGpuSingle.value = String(devs[0]);
        if (runGpuMulti) {
          runGpuMulti.querySelectorAll(".run-gpu-check").forEach((el) => {
            el.checked = devs.includes(Number(el.value));
          });
        }
      }
    }

    function updateRunModeVisibility() {
      const mode = (runMode?.value || "AUTO").toUpperCase();
      const sid = runServer?.value;
      const snap = snapshots.get(sid) || {};
      const hasGpu = Array.isArray(snap.gpus) && snap.gpus.length > 0;

      const single = mode === "S" || mode === "SM";
      const multi = mode === "M" || mode === "MNM";
      runGpuSingleWrap?.classList.toggle("hidden", !(single && hasGpu));
      runGpuMultiWrap?.classList.toggle("hidden", !(multi && hasGpu));
    }
    runMode?.addEventListener("change", updateRunModeVisibility);
    runServer?.addEventListener("change", () => {
      updateRunGpuOptions();
      updateRunModeVisibility();
    });

    btnAdd.addEventListener("click", () => {
      const ip = document.getElementById("modal-ip").value.trim();
      const port = document.getElementById("modal-port").value.trim() || "7777";
      const username = document.getElementById("modal-user").value.trim();
      const password = document.getElementById("modal-pass").value;
      if (!ip) return alert("请填写IP地址");
      const base = `http://${ip}:${port}`;
      const id = `${ip}-${port}`;
      if (sources.some((s) => s.id === id)) return alert("已添加该服务器");
      sources.push({ id, base, label: `${ip}:${port}`, expanded: false, meta: { type: "remote", username, password } });
      updateServerSelect();
      closeModal();
      log(`已添加服务器 ${id}`);

      // Immediate feedback for the newly added server
      const added = sources.find((s) => s.id === id);
      if (added) {
        fetchFrom(added).then((data) => {
          snapshots.set(id, data || {});
          if (data?.error) {
            log(`服务器 ${id} 连接失败：${data.error}`);
            log(`请确认远程已启动 server_agent，并监听 ${port}（以及防火墙放通）。`);
          }
          render();
        });
      }
      refreshAll();
    });

    async function loadConfigServers() {
      try {
        const res = await fetch("/api/servers", { cache: "no-store" });
        if (!res.ok) return;
        const list = await res.json();
        list.forEach((item) => {
          if (!item.ip) return;
          const id = item.id || `${item.ip}-${item.port || "default"}`;
          if (sources.some((s) => s.id === id)) return;
          const protocol = item.protocol || "http";
          const base = `${protocol}://${item.ip}${item.port ? ":" + item.port : ""}`;
          sources.push({ id, base, label: item.name || `${item.ip}:${item.port || ""}`, expanded: false, meta: { type: item.type, username: item.username } });
        });
        updateServerSelect();
      } catch (e) {
        console.warn("load servers failed", e);
      }
    }

    async function loadAlgorithms() {
      try {
        const res = await fetch("/api/algorithms", { cache: "no-store" });
        if (!res.ok) return;
        const list = await res.json();
        const opts = [{ id: "monitor", name: "仅监控资源", kind: "monitor" }, ...(Array.isArray(list) ? list : [])];
        algoSelect.innerHTML = opts
          .map((o) => {
            const disabled = o.disabled ? "disabled" : "";
            const label = o.name || o.id;
            const kind = o.kind || "ga";
            return `<option value="${o.id}" data-kind="${kind}" ${disabled}>${label}</option>`;
          })
          .join("");
        if (runAlgo) {
          const runOpts = opts.filter((o) => o.id !== "monitor");
          runAlgo.innerHTML = runOpts
            .map((o) => {
              const disabled = o.disabled ? "disabled" : "";
              const label = o.name || o.id;
              return `<option value="${o.id}" ${disabled}>${label}</option>`;
            })
            .join("");
        }
      } catch (e) {
        console.warn("load algorithms failed", e);
      }
    }

    async function loadDatasets() {
      try {
        const res = await fetch("/api/datasets", { cache: "no-store" });
        if (!res.ok) return;
        datasetsManifest = await res.json();
      } catch (e) {
        datasetsManifest = null;
      }
    }

    function updateRunDatasetOptions() {
      if (!runDataset) return;
      const algo = runAlgo?.value;
      const byAlgo = datasetsManifest?.by_algorithm || {};
      const list = Array.isArray(byAlgo?.[algo]) ? byAlgo[algo] : [];
      if (!list.length) {
        runDataset.innerHTML = `<option value="">(该算法暂无数据集清单)</option>`;
        return;
      }
      runDataset.innerHTML = list.map((d) => `<option value="${d}">${d}</option>`).join("");
    }

    algoSelect.addEventListener("change", () => {
      const sel = algoSelect.selectedOptions[0];
      const kind = sel?.dataset?.kind || (algoSelect.value === "monitor" ? "monitor" : "ga");
      warmupWrap.classList.toggle("hidden", kind === "monitor");
    });

    runAlgo?.addEventListener("change", updateRunDatasetOptions);

    async function fetchFrom(source) {
      try {
        const url = source.base ? `${source.base}/api/resources` : "/api/resources";
        const res = await fetch(url, { cache: "no-store" });
        if (!res.ok) throw new Error(res.status);
        return await res.json();
      } catch (e) {
        return { error: "连接失败或无响应", hostname: source.label };
      }
    }

    function render() {
      cardsDiv.innerHTML = sources
        .map((src) => {
          const data = snapshots.get(src.id) || {};
          const gpus = data.gpus || [];
          const cpu = data.cpu || {};
          const mem = data.memory || {};
          const expanded = !!src.expanded;

          const title = data.name || src.label || data.hostname || src.id;
          const gpuHtml = gpus.length
            ? gpus
                .map(
                  (g) => `
                  <div class="gpu-item">
                    <div class="gpu-title">GPU ${g.id} · ${g.name}</div>
                    <div style="color:var(--muted);margin-top:2px;">
                      显存：${fmt(g.used_mb)} / ${fmt(g.total_mb)} MB（功率 ${fmt(g.power_w, " W")}）
                    </div>
                    <div style="color:var(--muted);margin-top:2px;">
                      GPU 利用率：${fmt(g.gpu_util_percent, "%")} · 显存利用率：${fmt(g.mem_util_percent, "%")}
                    </div>
                  </div>`
                )
                .join("")
            : `<div style="font-size:12px;color:var(--muted);margin-top:6px;">无GPU信息</div>`;

          return `
            <div class="card ${expanded ? "card--expanded" : ""}" onclick="toggle('${src.id}')">
              <div class="card-top">
                <div class="card-left">
                  <div class="card-head">
                    <div>
                      <div class="card-name">${title}</div>
                      <div class="card-type">${src.meta?.type === "local" ? "本地机器" : src.meta?.type || "远程服务器"}</div>
                    </div>
                    <div class="badge">${data.time || data.timestamp || "--"}</div>
                  </div>
                  <div style="font-size:12px;color:var(--muted);">
                    Host: ${data.hostname || "N/A"}
                  </div>
                </div>

                <div class="card-mid">
                  <div class="stats">
                    <div class="stat">
                      <div class="stat-label">CPU 负载</div>
                      <div class="stat-value">${pct(cpu.usage_percent)}</div>
                    </div>
                    <div class="stat">
                      <div class="stat-label">内存占用</div>
                      <div class="stat-value">${pct(mem.percent)}</div>
                    </div>
                    <div class="stat">
                      <div class="stat-label">显卡数量</div>
                      <div class="stat-value">${gpus.length} 张</div>
                    </div>
                  </div>
                  ${data.error ? `<div class="error">错误：${data.error}</div>` : ""}
                </div>
              </div>

              <div class="card-bottom">
                <div class="details">
                  <div>CPU 负载均值：${fmt(cpu.load_avg?.[0], "", "N/A")}</div>
                  <div>内存：${fmt(mem.used_mb)} / ${fmt(mem.total_mb)} MB</div>
                  ${src.meta?.username ? `<div>用户：${src.meta.username}</div>` : ""}
                  ${gpuHtml}
                </div>
              </div>
            </div>
          `;
        })
        .join("");
    }

    function toggle(id) {
      const s = sources.find((x) => x.id === id);
      if (s) s.expanded = !s.expanded;
      render();
    }

    async function refreshAll() {
      try {
        const resp = await fetch("/api/all_resources", { cache: "no-store" });
        const all = await resp.json();
        Object.entries(all).forEach(([id, data]) => snapshots.set(id, data || {}));
        render();
      } catch (e) {
        console.error("获取资源失败", e);
      }
    }

    document.getElementById("btn-refresh").addEventListener("click", refreshAll);

    // Analysis interactions
    document.getElementById("btn-analyze").addEventListener("click", async () => {
      const sid = serverSelect.value;
      const algo = algoSelect.value;
      const src = sources.find((s) => s.id === sid) || sources[0];
      const warmup = Math.max(0, Number(warmupInput.value || 0));
      const isMonitor = algo === "monitor";

      let panelPinned = false;
      function renderComparison(compare) {
        if (!compare || !Array.isArray(compare.candidates)) return;
        panelPinned = true;
        const best = compare.best || {};
        const items = compare.candidates
          .map((c) => c?.plan)
          .filter((p) => p && typeof p.estimated_time_ms === "number");
        if (!items.length) return;

        const maxMs = Math.max(...items.map((p) => p.estimated_time_ms || 0), 1);
        const rows = compare.candidates
          .map((c) => {
            const p = c.plan || {};
            const ms = typeof p.estimated_time_ms === "number" ? p.estimated_time_ms : null;
            if (ms == null) return null;
            let label = c.tag || p.backend || "plan";
            if (p.backend === "cpu") label = "CPU";
            if (p.backend === "cuda") label = `GPU(${(p.devices || [])[0] ?? "-"})`;
            if (p.backend === "multi-gpu") label = `Multi-GPU(${(p.devices || []).length})`;
            const pct = Math.max(2, Math.round((ms / maxMs) * 100));
            const isBest = (p.backend === best.backend) && JSON.stringify(p.devices || []) === JSON.stringify(best.devices || []);
            const speedup = ms > 0 && best.estimated_time_ms ? (ms / best.estimated_time_ms) : null;
            return { label, ms, pct, isBest, speedup };
          })
          .filter(Boolean);

        const bestMs = typeof best.estimated_time_ms === "number" ? best.estimated_time_ms : null;
        const bestLabel = best.backend === "cpu"
          ? "CPU"
          : best.backend === "cuda"
            ? `GPU(${(best.devices || [])[0] ?? "-"})`
            : best.backend === "multi-gpu"
              ? `Multi-GPU(${(best.devices || []).length})`
              : (best.backend || "best");

        const barsHtml = rows
          .map((r) => {
            const color = r.isBest ? "#2563eb" : "#94a3b8";
            const border = r.isBest ? "1px solid #bfdbfe" : "1px solid #e2e8f0";
            const bg = r.isBest ? "#eff6ff" : "#f8fafc";
            const hint = r.isBest ? "最优" : (bestMs ? `慢 ${(r.ms / bestMs).toFixed(2)}×` : "");
            return `
              <div style="display:grid;gap:6px;padding:10px;border-radius:10px;background:${bg};border:${border};">
                <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                  <div style="font-weight:900;">${r.label}</div>
                  <div style="font-size:12px;color:var(--muted);white-space:nowrap;">${r.ms.toFixed(2)} ms ${hint ? `· ${hint}` : ""}</div>
                </div>
                <div style="height:10px;background:#e2e8f0;border-radius:999px;overflow:hidden;">
                  <div style="width:${r.pct}%;height:100%;background:${color};"></div>
                </div>
              </div>
            `;
          })
          .join("");

        // Real warmup curves (ms) if provided
        const warm = compare.warmup || {};
        const series = Array.isArray(warm.series) ? warm.series : [];
        const w = 520, h = 140, pad = 18;
        function polylineFor(ms) {
          if (!ms || ms.length < 2) return "";
          const minV = Math.min(...ms);
          const maxV = Math.max(...ms);
          return ms
            .map((y, i) => {
              const x = pad + (i / (ms.length - 1)) * (w - pad * 2);
              const yy = pad + (1 - (y - minV) / Math.max(1e-9, (maxV - minV))) * (h - pad * 2);
              return `${x.toFixed(1)},${yy.toFixed(1)}`;
            })
            .join(" ");
        }

        const cpuSeries = series.find((s) => (s.label || "").toUpperCase() === "CPU");
        const gpuSeries = series.find((s) => (s.label || "").toUpperCase().startsWith("GPU"));
        const mgpuSeries = series.find((s) => (s.label || "").toUpperCase().startsWith("MULTI-GPU"));
        const cpuPts = cpuSeries ? polylineFor(cpuSeries.ms) : "";
        const gpuPts = gpuSeries ? polylineFor(gpuSeries.ms) : "";
        const mgpuPts = mgpuSeries ? polylineFor(mgpuSeries.ms) : "";
        const curveLegend = cpuSeries || gpuSeries
          ? `
            <div style="display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted);">
              ${cpuSeries ? `<span><span style="display:inline-block;width:10px;height:10px;background:#2563eb;border-radius:3px;margin-right:6px;"></span>CPU</span>` : ""}
              ${gpuSeries ? `<span><span style="display:inline-block;width:10px;height:10px;background:#16a34a;border-radius:3px;margin-right:6px;"></span>${gpuSeries.label}</span>` : ""}
              ${mgpuSeries ? `<span><span style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:3px;margin-right:6px;"></span>${mgpuSeries.label}</span>` : ""}
            </div>
          `
          : `<div style="font-size:12px;color:var(--muted);">未提供 warmup 实测曲线（可能远程缺少 torch/cuda）。</div>`;

        gaPanel.innerHTML = `
          <div style="width:100%;display:grid;gap:12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div style="font-weight:900;">为什么选择该方案</div>
              <div style="font-size:12px;color:var(--muted);">最优：${bestLabel}${bestMs != null ? ` · ${bestMs.toFixed(2)} ms` : ""}</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr;gap:10px;">
              ${barsHtml}
            </div>
            <div style="display:grid;gap:8px;">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
                <div style="font-weight:900;">Warmup 实测耗时曲线（CPU vs GPU）</div>
                ${curveLegend}
              </div>
              <div style="border:1px dashed var(--card-border);border-radius:10px;background:var(--soft-bg);padding:10px;overflow:hidden;">
                <svg viewBox="0 0 ${w} ${h}" width="100%" height="140" preserveAspectRatio="none">
                  ${cpuPts ? `<polyline fill="none" stroke="#2563eb" stroke-width="3" points="${cpuPts}" />` : ""}
                  ${gpuPts ? `<polyline fill="none" stroke="#16a34a" stroke-width="3" points="${gpuPts}" />` : ""}
                  ${mgpuPts ? `<polyline fill="none" stroke="#f59e0b" stroke-width="3" points="${mgpuPts}" />` : ""}
                  <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
                  <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
                </svg>
              </div>
            </div>
          </div>
        `;
      }

      if (isMonitor) {
        log(`开始静态资源分析：${src.label}`);
      } else {
        log(`开始算法分析：${src.label} · ${algo}`);
        gaPanel.innerHTML = `<div>算法分析中...</div>`;
      }

      // Ask backend for adaptive plan (StrategyPlan)
      let plan = null;
      try {
        const resp = await fetch("/api/strategy_plan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ server_id: sid, algorithm: algo, warmup, objective: "time", multi_gpu: true, timeout_s: 60 }),
        });
        if (resp.ok) {
          plan = await resp.json();
        } else {
          let errBody = null;
          try {
            errBody = await resp.json();
          } catch (e) {
            errBody = { raw: await resp.text() };
          }
          log(`StrategyPlan 调用失败：HTTP ${resp.status} ${JSON.stringify(errBody)}`);
        }
      } catch (e) {
        plan = null;
        log(`StrategyPlan 调用异常：${e}`);
      }

      if (plan) {
        log(`StrategyPlan 结果：backend=${plan.backend} devices=${(plan.devices || []).join(",") || "-"} world_size=${plan.world_size || 1}`);
        if (plan.estimated_time_ms != null) log(`估计耗时：${plan.estimated_time_ms.toFixed(3)} ms`);
        if (plan.reason) log(`原因：${plan.reason}`);
        // Persist best plan per server for default run mode (AUTO)
        try { setSavedPlan(sid, plan); } catch (e) {}
      } else {
        log(`StrategyPlan 未获取到结果，使用默认策略。`);
      }

      if (isMonitor) {
        const snap = await fetchFrom(src);
        const cpu = snap.cpu || {};
        const mem = snap.memory || {};
        const gpus = snap.gpus || [];
        log(`Host: ${snap.hostname || src.label}`);
        log(`CPU: ${pct(cpu.usage_percent)} (load=${fmt(cpu.load_avg?.[0], "", "N/A")})`);
        log(`MEM: ${pct(mem.percent)} (${fmt(mem.used_mb)} / ${fmt(mem.total_mb)} MB)`);
        log(`GPU: ${gpus.length} 张`);
        gaPanel.textContent = "等待数据...";
        return;
      }

      // Fetch candidate comparison and render explanation chart
      try {
        const resp = await fetch("/api/strategy_compare", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ server_id: sid, objective: "time", multi_gpu: true, warmup_iters: Math.max(2, Math.min(8, warmup || 4)), timeout_s: 60 }),
        });
        if (resp.ok) {
          const compare = await resp.json();
          renderComparison(compare);
        } else {
          let errBody = null;
          try { errBody = await resp.json(); } catch (e) { errBody = { raw: await resp.text() }; }
          log(`StrategyCompare 失败：HTTP ${resp.status} ${JSON.stringify(errBody)}`);
        }
      } catch (e) {
        log(`StrategyCompare 异常：${e}`);
      }

      // Simulated GA flow (warmup + analysis)
      setTimeout(() => log("正在初始化算法..."), 200);
      setTimeout(() => log(`执行 Warm up (${warmup} 次)...`), 700);
      setTimeout(() => log("算法分析中..."), 1200);

      setTimeout(() => {
        log("分析完成，生成模拟结果。");
        if (!panelPinned) {
          gaPanel.innerHTML = `
            <div>
              <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">等待图表数据...</div>
              <div style="font-size:20px;font-weight:900;color:var(--blue-700);">Best Plan: ${algo}</div>
              ${plan ? `<div style="font-size:12px;color:var(--muted);margin-top:6px;">backend=${plan.backend}, world_size=${plan.world_size || 1}</div>` : ""}
            </div>`;
        }
      }, 2000);
    });

    // ---------- Module 3: run & monitor ----------
    function historyLoad() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]") || [];
      } catch (e) {
        return [];
      }
    }
    function historySave(items) {
      try {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(items.slice(0, 50)));
      } catch (e) {}
    }
    function historyRender() {
      const items = historyLoad();
      if (!items.length) {
        historyList.innerHTML = `<div style="color:var(--muted);font-size:13px;">暂无历史记录。</div>`;
        return;
      }
      historyList.innerHTML = items
        .map((it, idx) => {
          return `
            <div class="history-item" data-idx="${idx}">
              <div style="font-weight:900;">${it.algorithm} · ${it.server_label || it.server_id}</div>
              <div class="history-meta">${it.timestamp} · state=${it.state} · best=${it.best_score ?? "-"}</div>
            </div>
          `;
        })
        .join("");
      historyList.querySelectorAll(".history-item").forEach((el) => {
        el.addEventListener("click", () => {
          const idx = Number(el.dataset.idx);
          const it = historyLoad()[idx];
          if (!it) return;
          historyDetail.textContent = [
            `# ${it.algorithm} @ ${it.server_label || it.server_id}`,
            `time: ${it.timestamp}`,
            `state: ${it.state}`,
            `task_id: ${it.task_id}`,
            it.best_score != null ? `best_score: ${it.best_score}` : "",
            "",
            ...(it.logs || []),
          ]
            .filter(Boolean)
            .join("\n");
        });
      });
    }
    btnHistoryClear?.addEventListener("click", () => {
      historySave([]);
      historyRender();
      historyDetail.textContent = "历史已清空。";
    });

    function appendRunLog(lines) {
      if (!lines || !lines.length) return;
      if (runLog.textContent.trim() === "等待任务…") runLog.textContent = "";
      runLog.textContent += lines.join("\n") + "\n";
      runLog.scrollTop = runLog.scrollHeight;
    }
    btnRunClear?.addEventListener("click", () => {
      runLog.textContent = "";
      lastLogCount = 0;
    });

    function renderRunCharts(result) {
      if (!result) return;
      const conv = Array.isArray(result.convergence) ? result.convergence : [];
      const metrics = Array.isArray(result.metrics) ? result.metrics : [];
      if (!conv.length && !metrics.length) return;

      // convergence polyline
      const w = 520, h = 140, pad = 18;
      function polylineFor(arr) {
        if (!arr || arr.length < 2) return "";
        const minV = Math.min(...arr);
        const maxV = Math.max(...arr);
        return arr
          .map((y, i) => {
            const x = pad + (i / (arr.length - 1)) * (w - pad * 2);
            const yy = pad + (1 - (y - minV) / Math.max(1e-9, maxV - minV)) * (h - pad * 2);
            return `${x.toFixed(1)},${yy.toFixed(1)}`;
          })
          .join(" ");
      }

      const cpuArr = metrics.map((m) => m.cpu_usage_percent).filter((x) => x != null);
      const memArr = metrics.map((m) => m.memory_percent).filter((x) => x != null);
      const cpuPts = polylineFor(cpuArr);
      const memPts = polylineFor(memArr);
      const convPts = polylineFor(conv);

      runChart.innerHTML = `
        <div style="width:100%;display:grid;gap:12px;">
          <div style="font-weight:900;">收敛曲线（示例）</div>
          <div style="border:1px dashed var(--card-border);border-radius:10px;background:var(--soft-bg);padding:10px;overflow:hidden;">
            <svg viewBox="0 0 ${w} ${h}" width="100%" height="140" preserveAspectRatio="none">
              ${convPts ? `<polyline fill="none" stroke="#2563eb" stroke-width="3" points="${convPts}" />` : ""}
              <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
              <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
            </svg>
          </div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="font-weight:900;">轮次资源监视（每轮采样）</div>
            <div style="font-size:12px;color:var(--muted);">
              <span style="display:inline-block;width:10px;height:10px;background:#f59e0b;border-radius:3px;margin-right:6px;"></span>CPU%
              <span style="display:inline-block;width:10px;height:10px;background:#16a34a;border-radius:3px;margin:0 6px 0 12px;"></span>MEM%
            </div>
          </div>
          <div style="border:1px dashed var(--card-border);border-radius:10px;background:var(--soft-bg);padding:10px;overflow:hidden;">
            <svg viewBox="0 0 ${w} ${h}" width="100%" height="140" preserveAspectRatio="none">
              ${cpuPts ? `<polyline fill="none" stroke="#f59e0b" stroke-width="3" points="${cpuPts}" />` : ""}
              ${memPts ? `<polyline fill="none" stroke="#16a34a" stroke-width="3" points="${memPts}" />` : ""}
              <line x1="${pad}" y1="${h - pad}" x2="${w - pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
              <line x1="${pad}" y1="${pad}" x2="${pad}" y2="${h - pad}" stroke="#cbd5e1" stroke-width="2"/>
            </svg>
          </div>
        </div>
      `;
    }

    async function startRun() {
      const server_id = runServer.value;
      const algorithm = runAlgo.value;
      const dataset = runDataset?.value || "";
      const iterations = Math.max(1, Number(runIters.value || 1));
      const crossover_rate = Math.min(1, Math.max(0, Number(runPc.value || 0.8)));
      const mutate_rate = Math.min(1, Math.max(0, Number(runPm.value || 0.2)));
      const mode = (runMode.value || "AUTO").toUpperCase();

      let devices = [];
      const snap = snapshots.get(server_id) || {};
      const hasGpu = Array.isArray(snap.gpus) && snap.gpus.length > 0;

      if (mode === "AUTO") {
        const saved = getSavedPlan(server_id);
        if (saved && saved.plan && Array.isArray(saved.plan.devices)) {
          devices = saved.plan.devices;
        }
      } else if (mode === "CPU") {
        devices = [];
      } else if ((mode === "S" || mode === "SM") && hasGpu) {
        devices = [Number(runGpuSingle.value)];
      } else if ((mode === "M" || mode === "MNM") && hasGpu) {
        const checked = Array.from(runGpuMulti.querySelectorAll(".run-gpu-check"))
          .filter((el) => el.checked)
          .map((el) => Number(el.value));
        devices = checked;
      }

      // reset UI
      runState.textContent = "starting";
      runTaskId.textContent = "-";
      runProgress.style.width = "0%";
      runProgressText.textContent = "0%";
      runBest.textContent = "-";
      runChart.textContent = "等待数据...";
      runLog.textContent = "";
      lastLogCount = 0;

      const resp = await fetch("/api/analysis/start", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ server_id, algorithm, dataset, iterations, crossover_rate, mutate_rate, mode, devices, timeout_s: 20 }),
      });
      if (!resp.ok) {
        let errBody = null;
        try { errBody = await resp.json(); } catch (e) { errBody = { raw: await resp.text() }; }
        appendRunLog([`[ERROR] start failed: HTTP ${resp.status} ${JSON.stringify(errBody)}`]);
        runState.textContent = "error";
        return;
      }
      const data = await resp.json();
      runTaskId.textContent = data.task_id || "-";
      runState.textContent = data.status || "started";
      appendRunLog([`[INFO] task started: ${data.task_id}`]);

      // poll status
      if (currentPoll) clearInterval(currentPoll);
      currentPoll = setInterval(() => pollRunStatus(server_id), 1200);
      pollRunStatus(server_id);
    }

    async function pollRunStatus(server_id) {
      const resp = await fetch(`/api/analysis/status?server_id=${encodeURIComponent(server_id)}&timeout_s=10`, { cache: "no-store" });
      if (!resp.ok) return;
      const st = await resp.json();
      runState.textContent = st.state || "unknown";
      const p = Number(st.progress || 0);
      runProgress.style.width = `${Math.max(0, Math.min(100, p))}%`;
      runProgressText.textContent = `${Math.max(0, Math.min(100, p))}%`;

      const logs = Array.isArray(st.logs) ? st.logs : [];
      if (logs.length > lastLogCount) {
        appendRunLog(logs.slice(lastLogCount));
        lastLogCount = logs.length;
      }

      if (st.result) {
        const best = st.result.best_score;
        if (best != null) runBest.textContent = String(best);
        renderRunCharts(st.result);
      }

      if (st.state === "completed" || st.state === "error" || st.state === "idle") {
        if (currentPoll) {
          clearInterval(currentPoll);
          currentPoll = null;
        }
        // persist to history
        const items = historyLoad();
        items.unshift({
          timestamp: new Date().toLocaleString(),
          server_id,
          server_label: (sources.find((s) => s.id === server_id) || {}).label,
          algorithm: runAlgo.value,
          dataset: runDataset?.value || null,
          task_id: st.task_id,
          state: st.state,
          best_score: st.result ? st.result.best_score : null,
          hyperparams: st.result ? st.result.hyperparams : null,
          logs: logs.slice(-500),
          result: st.result || null,
        });
        historySave(items);
        historyRender();
      }
    }

    btnRun?.addEventListener("click", startRun);

    // Boot
    setInterval(refreshAll, 2000);
    (async () => {
      await loadAlgorithms();
      await loadDatasets();
      await loadConfigServers();
      refreshAll();
      historyRender();
      updateRunDatasetOptions();
    })();
  </script>
</body>
</html>
